{% extends 'main/base.html' %}

{% load static %}
{% load course_filters %}

{% block title %}{{ course.name }} - دورة تدريبية{% endblock %}

{% block head %}
    {{ block.super }}
<link rel="stylesheet" href="{% static 'css/course-view.css' %}">
<script src="{% static 'js/course-view.js' %}"></script>
{% endblock %}

{% block content %}

<div class="container py-4" dir="rtl">
  <div class="row">
    <!-- Course Image and Basic Info -->
    <div class="col-md-4 mb-4">
      <div class="card shadow-sm border-0 rounded-4 overflow-hidden">
        {% if course.image_course %}
          <img src="{{ course.image_course.url }}" class="card-img-top" alt="{{ course.name }}">
        {% endif %}
        <div class="card-body">
          <h4 class="card-title fw-bold">{{ course.name }}</h4>
          <p class="text-muted">{{ course.description|truncatewords:15 }}</p>
          
          <div class="d-flex flex-wrap gap-2 mb-3">
            <span class="badge bg-primary bg-opacity-10 text-primary rounded-pill px-3">
              <i class="fas fa-graduation-cap me-1"></i> {{ course.total_video }} دروس
            </span>
            <span class="badge bg-primary bg-opacity-10 text-primary rounded-pill px-3">
              <i class="fas fa-signal me-1"></i> {{ course.get_level_display }}
            </span>
          </div>
          
          <div class="progress mb-3" style="height: 8px;">
            <div class="progress-bar bg-primary" role="progressbar" 
                 style="width: {{ progress }}%" aria-valuenow="{{ progress }}" 
                 aria-valuemin="0" aria-valuemax="100"></div>
          </div>
          <div class="d-flex justify-content-between">
            <small class="text-muted progress-text">إكمال الدورة: {{ progress }}%</small>
            <small>
              <span class="badge bg-primary bg-opacity-10 text-primary rounded-pill me-1" title="فيديوهات">
                <i class="fas fa-play-circle"></i> {{ completed_videos|length }}/{{ course.total_video|default:0 }}
              </span>
              {% if quizzes_count %}
              <span class="badge bg-warning bg-opacity-10 text-warning rounded-pill me-1" title="اختبارات">
                <i class="fas fa-question-circle"></i> {{ completed_quizzes|length }}/{{ quizzes_count }}
              </span>
              {% endif %}
              {% if assignments_count %}
              <span class="badge bg-success bg-opacity-10 text-success rounded-pill me-1" title="واجبات">
                <i class="fas fa-tasks"></i> {{ completed_assignments|length }}/{{ assignments_count }}
              </span>
              {% endif %}
              {% if pdfs_count %}
              <span class="badge bg-info bg-opacity-10 text-info rounded-pill" title="ملفات PDF">
                <i class="fas fa-file-pdf"></i> {{ completed_pdfs|length }}/{{ pdfs_count }}
              </span>
              {% endif %}
            </small>
          </div>
        </div>
      </div>
      
      <!-- Instructor Card -->
      <div class="card shadow-sm border-0 rounded-4 mt-3">
        <div class="card-body">
          <h6 class="fw-bold mb-3">مقدم الدورة</h6>
          <div class="d-flex align-items-center">
            {% if course.teacher.profile.image %}
              <img src="{{ course.teacher.profile.image.url }}" 
                   class="rounded-circle me-3 border border-2 border-primary" 
                   width="60" height="60" alt="{{ course.teacher.profile.name }}">
            {% else %}
              <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-3" 
                   style="width: 60px; height: 60px;">
                {{ course.teacher.profile.name|slice:':1'|upper }}
              </div>
            {% endif %}
            <div>
              <h6 class="mb-0 fw-bold">{{ course.teacher.profile.name }}</h6>
              <small class="text-muted">مدرب معتمد</small>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Course Content -->
    <div class="col-md-8">
      <div class="card shadow-sm border-0 rounded-4 overflow-hidden">
        <!-- Current Video/Content -->
        <div class="video-container bg-dark">
          {% if current_content.type == 'video' %}
            <video src="{{ current_content.content.video.url }}" 
                   class="w-100" controls style="max-height: 450px;">
              Your browser does not support the video tag.
            </video>
          {% else %}
            <div class="pdf-viewer-container" style="height: 450px;">
              <embed src="{{ current_content.content.file.url }}" 
                     type="application/pdf" width="100%" height="100%">
            </div>
          {% endif %}
        </div>
        
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0 fw-bold">
              {% if current_content.type == 'video' %}
                {{ current_content.content.name }}
              {% else %}
                ملاحظات {{ current_content.module.name }}
              {% endif %}
            </h4>
            <div>
              {% if prev_content %}
                {% if prev_content.type == 'video' %}
                  <a href="{% url 'courseviewpagevideo' course.id prev_content.content.id %}" 
                     class="btn btn-sm btn-outline-primary rounded-pill me-2">
                    <i class="fas fa-arrow-right"></i> السابق
                  </a>
                {% elif prev_content.type == 'note' %}
                  <a href="{% url 'courseviewpagenote' course.id prev_content.content.id %}" 
                     class="btn btn-sm btn-outline-primary rounded-pill me-2">
                    <i class="fas fa-arrow-right"></i> السابق
                  </a>
                {% endif %}
              {% endif %}
              {% if next_content %}
                {% if next_content.type == 'video' %}
                  <a href="{% url 'courseviewpagevideo' course.id next_content.content.id %}" 
                     class="btn btn-sm btn-primary rounded-pill">
                    التالي <i class="fas fa-arrow-left"></i>
                  </a>
                {% elif next_content.type == 'note' %}
                  <a href="{% url 'courseviewpagenote' course.id next_content.content.id %}" 
                     class="btn btn-sm btn-primary rounded-pill">
                    التالي <i class="fas fa-arrow-left"></i>
                  </a>
                {% endif %}
              {% else %}
                <button class="btn btn-sm btn-success rounded-pill">
                  إكمال الدورة <i class="fas fa-check"></i>
                </button>
              {% endif %}
            </div>
          </div>
          
          <p class="text-muted">
            {% if current_content.type == 'video' %}
              {{ current_content.content.description|default:"لا يوجد وصف متاح لهذا الفيديو." }}
            {% else %}
              ملاحظات مرفقة لمساعدتك في فهم المحتوى بشكل أفضل.
            {% endif %}
          </p>
          
          {% if current_content.type == 'video' and current_content.content.resources %}
            <div class="resources-section mt-4">
              <h6 class="fw-bold mb-3"><i class="fas fa-paperclip me-2"></i>الملفات المرفقة</h6>
              <div class="d-flex flex-wrap gap-2">
                {% for resource in current_content.content.resources.all %}
                  <a href="{{ resource.file.url }}" class="btn btn-sm btn-outline-primary rounded-pill">
                    <i class="fas fa-download me-1"></i> {{ resource.name }}
                  </a>
                {% endfor %}
              </div>
            </div>
          {% endif %}
        </div>
      </div>
      
      <!-- Course Modules Accordion -->
      <div class="card shadow-sm border-0 rounded-4 mt-4">
        <div class="card-body">
          <h5 class="fw-bold mb-4">محتوى الدورة</h5>
          
          <div class="accordion" id="courseModules">
            {% for module in course.module_set.all %}
            <div class="accordion-item border-0 mb-2 rounded-3 overflow-hidden">
              <h6 class="accordion-header" id="moduleHeading{{ module.id }}">
                <button class="accordion-button {% if not forloop.first %}collapsed{% endif %} bg-light" 
                        type="button" data-bs-toggle="collapse" 
                        data-bs-target="#moduleCollapse{{ module.id }}" 
                        aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}" 
                        aria-controls="moduleCollapse{{ module.id }}">
                  <div class="d-flex align-items-center">
                    <span class="badge bg-primary rounded-circle me-3 d-flex align-items-center justify-content-center" 
                          style="width: 30px; height: 30px;">{{ forloop.counter }}</span>
                    <span class="fw-bold">{{ module.name }}</span>
                  </div>
                </button>
              </h6>
              
              <div id="moduleCollapse{{ module.id }}" 
                   class="accordion-collapse collapse {% if forloop.first %}show{% endif %}" 
                   aria-labelledby="moduleHeading{{ module.id }}" 
                   data-bs-parent="#courseModules">
                <div class="accordion-body pt-0">
                  <div class="list-group list-group-flush">
                    {% for video in module.video_set.all %}
                      <a href="{% url 'courseviewpagevideo' course.id video.id %}" 
                         class="list-group-item list-group-item-action border-0 py-3 d-flex align-items-center {% if current_content.type == 'video' and current_content.content.id == video.id %}active{% endif %}">
                        <div class="content-icon me-3">
                          <i class="fas fa-play-circle {% if current_content.type == 'video' and current_content.content.id == video.id %}text-white{% else %}text-primary{% endif %}"></i>
                        </div>
                        <div class="flex-grow-1">
                          <div class="d-flex justify-content-between">
                            <span class="content-title">{{ video.name }}</span>
                            <small class="text-muted">{{ video.duration|default:"0:00" }}</small>
                          </div>
                          {% if video.id in completed_videos %}
                            <small class="text-success"><i class="fas fa-check-circle"></i> مكتمل</small>
                          {% endif %}
                        </div>
                      </a>
                    {% endfor %}
                    
                    {% for note in module.notes_set.all %}
                      <a href="{% url 'courseviewpagenote' course.id note.id %}" 
                         class="list-group-item list-group-item-action pdf-item border-0 py-3 d-flex align-items-center {% if current_content.type == 'note' and current_content.content.id == note.id %}active{% endif %}" data-pdf-id="{{ note.id }}">
                        <div class="content-icon me-3">
                          <i class="fas fa-file-pdf {% if current_content.type == 'note' and current_content.content.id == note.id %}text-white{% else %}text-info{% endif %}"></i>
                        </div>
                        <div class="flex-grow-1">
                          <div class="d-flex justify-content-between">
                            <span class="content-title">ملاحظات {{ forloop.counter }}</span>
                            <small class="text-muted">PDF</small>
                          </div>
                          {% if note.id in completed_pdfs %}
                            <small class="text-success"><i class="fas fa-check-circle"></i> تمت القراءة</small>
                          {% endif %}
                        </div>
                      </a>
                    {% endfor %}
                    
                    {% for quiz in quizzes %}
                      {% if quiz.module.id == module.id %}
                      <a href="{% url 'quiz_detail' quiz.id %}" 
                         class="list-group-item list-group-item-action quiz-item border-0 py-3 d-flex align-items-center" data-quiz-id="{{ quiz.id }}">
                        <div class="content-icon me-3">
                          <i class="fas fa-question-circle text-warning"></i>
                        </div>
                        <div class="flex-grow-1">
                          <div class="d-flex justify-content-between">
                            <span class="content-title">{{ quiz.title }}</span>
                            <small class="text-muted">{{ quiz.questions.count }} سؤال</small>
                          </div>
                          {% if quiz.id in completed_quizzes %}
                            <small class="text-success"><i class="fas fa-check-circle"></i> تم الإكمال</small>
                          {% endif %}
                        </div>
                      </a>
                      {% endif %}
                    {% endfor %}
                    
                    {% for assignment in assignments %}
                      {% if assignment.module.id == module.id %}
                      <a href="{% url 'assignment_detail' assignment.id %}" 
                         class="list-group-item list-group-item-action assignment-item border-0 py-3 d-flex align-items-center" data-assignment-id="{{ assignment.id }}">
                        <div class="content-icon me-3">
                          <i class="fas fa-tasks text-success"></i>
                        </div>
                        <div class="flex-grow-1">
                          <div class="d-flex justify-content-between">
                            <span class="content-title">{{ assignment.title }}</span>
                            <small class="text-muted">تسليم: {{ assignment.due_date|date:"d/m/Y" }}</small>
                          </div>
                          {% if assignment.id in completed_assignments %}
                            <small class="text-success"><i class="fas fa-check-circle"></i> تم التسليم</small>
                          {% endif %}
                        </div>
                      </a>
                      {% endif %}
                    {% endfor %}
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock content %}
