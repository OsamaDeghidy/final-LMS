{% extends 'main/base.html' %}

{% load static %}
{% load course_filters %}

{% block title %}{{ course.name }} - دورة تدريبية{% endblock %}

{% block head %}
    {{ block.super }}
<link rel="stylesheet" href="{% static 'css/course-view.css' %}">
<script src="{% static 'js/course-view.js' %}"></script>
{% endblock %}

{% block content %}

<!-- Course Header Section -->
<div class="course-header text-white py-4 mb-0">
  <div class="container-fluid">
    <div class="row align-items-center">
      <div class="col-12">
        <h1 class="h3 fw-bold mb-2">{{ course.name }}</h1>
        <div class="d-flex align-items-center flex-wrap gap-2">
          <span class="badge bg-primary rounded-pill px-3 py-2 d-inline-flex align-items-center">
            <i class="fas fa-graduation-cap me-2"></i> {{ course.total_video }} دروس
          </span>
          <span class="badge bg-success rounded-pill px-3 py-2 d-inline-flex align-items-center">
            <i class="fas fa-clock me-2"></i> {{ course.vidoes_time }}
          </span>
          <span class="badge bg-info rounded-pill px-3 py-2 d-inline-flex align-items-center">
            <i class="fas fa-signal me-2"></i> {{ course.get_level_display }}
          </span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Main Course Content -->
<div class="course-content">
  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar Navigation -->
      <div class="col-lg-3 course-sidebar p-0">
        <div class="sidebar-content bg-light border-end h-100 overflow-auto">
          <div class="p-3 border-bottom bg-white sticky-top">
            <div class="progress mb-2" style="height: 8px;">
              <div class="progress-bar bg-primary" role="progressbar" style="width: {{ progress }}%;" 
                   aria-valuenow="{{ progress }}" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            <div class="d-flex justify-content-between align-items-center small">
              <span class="text-muted">تقدمك في الدورة</span>
              <span class="fw-bold">{{ progress }}%</span>
            </div>
          </div>

          <!-- Course Modules Navigation -->
          <div class="modules-nav">
            {% for module in course.module_set.all %}
            <div class="module-section">
              <div class="module-header p-3 border-bottom d-flex align-items-center" 
                   data-bs-toggle="collapse" data-bs-target="#module{{ module.id }}" 
                   role="button" aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}">
                <i class="fas fa-chevron-down me-2 text-primary"></i>
                <div>
                  <h6 class="mb-1 fw-bold">{{ module.name }}</h6>
                  <small class="text-muted">{{ module.video_set.count }} فيديو • {{ module.notes_set.count }} ملاحظات</small>
                </div>
              </div>
              
              <div class="collapse {% if forloop.first %}show{% endif %}" id="module{{ module.id }}">
                <div class="module-content">
                  <!-- Videos -->
                  {% for video in module.video_set.all %}
                  <a href="#video-{{ video.id }}" class="content-item p-3 border-bottom d-flex align-items-center text-decoration-none text-dark {% if video.id == video_id %}active{% endif %}" data-content-id="video-{{ video.id }}">
                    <div class="icon-wrapper {% if video.id in completed_videos %}bg-success{% else %}bg-primary{% endif %} rounded-circle me-3 p-2">
                      <i class="fas {% if video.id in completed_videos %}fa-check{% else %}fa-play{% endif %} text-white"></i>
                    </div>
                    <div class="flex-grow-1">
                      <h6 class="mb-1 small fw-bold">{{ video.name }}</h6>
                      <small class="text-muted">{{ video.duration|default:"0:00" }}</small>
                    </div>
                  </a>
                  {% endfor %}
                  
                  <!-- Notes -->
                  {% for note in module.notes_set.all %}
                  <a href="#note-{{ note.id }}" class="content-item p-3 border-bottom d-flex align-items-center text-decoration-none text-dark" data-content-id="note-{{ note.id }}">
                    <div class="icon-wrapper bg-success rounded-circle me-3 p-2">
                      <i class="fas fa-file-alt text-white"></i>
                    </div>
                    <div class="flex-grow-1">
                      <h6 class="mb-1 small fw-bold">ملاحظات {{ forloop.counter }}</h6>
                      <small class="text-muted">PDF</small>
                    </div>
                  </a>
                  {% endfor %}
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
      
      <!-- Main Content Area -->
      <div class="col-lg-9 main-content p-4">
        <div class="content-container">
          {% for module in course.module_set.all %}
            {% for video in module.video_set.all %}
            <div id="video-{{ video.id }}" class="content-section {% if not forloop.first or not forloop.parentloop.first %}d-none{% endif %}">
              <div class="card border-0 shadow-sm">
                <div class="card-header bg-white py-3 border-bottom">
                  <h4 class="mb-0">{{ video.name }}</h4>
                </div>
                <div class="card-body p-0">
                  <div class="video-container position-relative">
                    <video
                      src="{{ video.video.url }}"
                      type="{{ video.video.content_type }}"
                      class="w-100"
                      controls
                      {% if video.id in video_progress %}data-last-position="{{ video_progress.last_position }}"{% endif %}
                      {% if video.id in completed_videos %}data-watched="true"{% endif %}
                    >
                      Your browser does not support the video tag.
                    </video>
                    
                    {% if video.id in completed_videos %}
                    <div class="video-completed-badge">
                      <i class="fas fa-check-circle"></i> تم مشاهدة هذا الفيديو
                    </div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
            
            {% for note in module.notes_set.all %}
            <div id="note-{{ note.id }}" class="content-section d-none">
              <div class="card border-0 shadow-sm">
                <div class="card-header bg-white py-3 border-bottom">
                  <h4 class="mb-0">ملاحظات {{ forloop.counter }}</h4>
                </div>
                <div class="card-body">
                  <embed src="{{ note.file.url }}" type="application/pdf" width="100%" height="600px">
                </div>
              </div>
            </div>
            {% endfor %}
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>
          <div class="progress">
            {% with width_value=progress|stringformat:'f' %}
            <div class="progress-bar bg-warning" role="progressbar" 
                 style="width: {{ width_value|floatformat:0 }}%;"
                 aria-valuenow="{{ width_value|floatformat:0 }}"
                 aria-valuemin="0" aria-valuemax="100"></div>
            {% endwith %}
          </div>
        </div>
        <div class="instructor d-flex align-items-center">
          {% if course.teacher.profile.image %}
            <img src="{{ course.teacher.profile.image.url }}" alt="{{ course.teacher.profile.name }}" class="rounded-circle me-2" width="40" height="40">
          {% else %}
            <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center me-2" style="width: 40px; height: 40px;">
              {{ course.teacher.profile.name|slice:':1'|upper }}
            </div>
          {% endif %}
          <div>
            <p class="mb-0 text-white-50">المدرب: <span class="text-white">{{ course.teacher.profile.name }}</span></p>
          </div>
        </div>
      </div>
      <div class="col-lg-4 text-center text-lg-end mt-4 mt-lg-0">
        {% if course.image_course %}
          <img src="{{ course.image_course.url }}" alt="{{ course.name }}" class="img-fluid rounded-3 shadow course-thumbnail">
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Main Course Content -->
<main class="container-fluid py-5">
  <div class="row">
    <!-- Main Content Column -->
    <div class="col-lg-8 pe-lg-5">
      <!-- Video Player Section (if available) -->
      {% if video %}
      <section class="mb-5">
        <div class="card border-0 shadow-sm">
          <div class="card-header bg-white d-flex justify-content-between align-items-center py-3 border-bottom">
            <h3 class="mb-0 h5">{{ video.name }}</h3>
            <span class="badge bg-primary">{{ video.duration|default:"0:00" }}</span>
          </div>
          <div class="card-body p-0">
            <div class="video-player">
              <div class="video-container position-relative">
                <video
                  src="{{ video.video.url }}"
                  type="{{ video.video.content_type }}"
                  id="vid"
                  class="w-100 rounded-0"
                  controls
                  {% if video_progress.last_position %}
                  data-last-position="{{ video_progress.last_position }}"
                  {% endif %}
                  {% if video_progress.watched %}
                  data-watched="true"
                  {% endif %}
                >
                  Your browser does not support the video tag.
                </video>
                
                {% if video_progress.watched %}
                <div class="video-completed-badge position-absolute top-0 end-0 m-3 bg-success text-white px-3 py-2 rounded-pill">
                  <i class="fas fa-check-circle me-1"></i> تم مشاهدة هذا الفيديو
                </div>
                {% endif %}
              </div>
              
              {% if questions %}
              <div class="quiz-section mt-4 p-4">
                <h4 class="mb-3"><i class="fas fa-question-circle text-primary me-2"></i>اختبار قصير</h4>
                <form class="hide quesForm bg-light p-4 rounded-3 shadow-sm" id="ques">
                  {% csrf_token %}
                  {% for question in questions %}
                  <div class="quesBox mb-4">
                    <h5 class="fw-bold">سؤال {{ forloop.counter }}: {{ question.text }}</h5>
                    <div class="answers-list mt-3">
                      {% for answer in question.answer_set.all %}
                      <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" name="{{ question.id }}[]" value="{{ answer.id }}" id="answer{{ answer.id }}">
                        <label class="form-check-label" for="answer{{ answer.id }}">
                          {{ answer.text }}
                        </label>
                      </div>
                      {% endfor %}
                    </div>
                  </div>
                  {% endfor %}
                  <button id="sub" type="submit" class="btn btn-primary rounded-pill px-4 py-2 mt-3">
                    <i class="fas fa-paper-plane me-2"></i>إرسال الإجابات
                  </button>
                </form>
              </div>
              {% endif %}
              
              <div class="hide results bg-light p-4 rounded-3 shadow-sm mt-4" id="results">
                <h4 class="mb-3 d-flex align-items-center">
                  <i class="fas fa-chart-bar text-primary me-2"></i>نتائج الاختبار
                </h4>
                {% if quiz %}
                <div class="d-flex justify-content-between mb-3">
                  <p class="mb-0"><strong>درجة النجاح:</strong> {{ quiz.pass_mark }}%</p>
                  <p class="mb-0"><strong>درجتك:</strong> <span class="fs-5 fw-bold {% if passed %}text-success{% else %}text-danger{% endif %}">{{ score }}%</span></p>
                </div>
                <div class="alert {% if passed %}alert-success{% else %}alert-danger{% endif %}">
                  {% if passed %}
                    <i class="fas fa-check-circle me-2"></i>تهانينا! لقد اجتزت الاختبار بنجاح.
                  {% else %}
                    <i class="fas fa-times-circle me-2"></i>لم تجتز الاختبار. يرجى المحاولة مرة أخرى.
                  {% endif %}
                </div>
                {% else %}
                <div class="alert alert-info">
                  <i class="fas fa-info-circle me-2"></i>لا يوجد اختبار مرتبط بهذا الفيديو.
                </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </section>
      {% endif %}

      {% for module in course.module_set.all %}
      <section class="mb-5">
        <div class="card border-0 shadow-sm module-card">
          <div class="card-header bg-white d-flex justify-content-between align-items-center py-3 border-bottom">
            <div class="d-flex align-items-center">
              <div class="module-icon bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3">
                <i class="fas fa-book"></i>
              </div>
              <h3 class="mb-0 h5">{{ module.name }}</h3>
            </div>
            <span class="badge bg-light text-dark">{{ module.video_set.count }} محاضرات • {{ module.duration|default:"0:00:00" }}</span>
          </div>
          <div class="card-body">
            <div class="accordion" id="module{{ module.id }}Accordion">
              <div class="accordion-item border-0">
                <h2 class="accordion-header" id="module{{ module.id }}Heading">
                  <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#module{{ module.id }}Content" aria-expanded="true" aria-controls="module{{ module.id }}Content">
                    <i class="fas fa-list-ul me-2"></i> محتوى الوحدة
                  </button>
                </h2>
                <div id="module{{ module.id }}Content" class="accordion-collapse collapse show" aria-labelledby="module{{ module.id }}Heading">
                  <div class="accordion-body p-0">
                    <div class="list-group list-group-flush">
                      {% for video in module.video_set.all %}
                      <a href="{% url 'courseviewpagevideo' course_id=course.id video_id=video.id %}" class="list-group-item list-group-item-action d-flex align-items-center py-3 px-3 hover-bg">
                        <div class="flex-shrink-0 me-3">
                          <div class="video-icon {% if video.id == video_id %}bg-success{% else %}bg-primary{% endif %} text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 36px; height: 36px;">
                            <i class="fas {% if video.id == video_id %}fa-play-circle{% else %}fa-play{% endif %}"></i>
                          </div>
                        </div>
                        <div class="flex-grow-1">
                          <h6 class="mb-1">{{ video.name }}</h6>
                          <p class="text-muted mb-0 small">{{ video.duration|default:"0" }} دقيقة</p>
                        </div>
                        <div class="ms-auto">
                          {% if video_progress and video.id in completed_videos %}
                          <span class="badge bg-success rounded-pill"><i class="fas fa-check me-1"></i>تم</span>
                          {% else %}
                          <i class="fas fa-chevron-right text-muted"></i>
                          {% endif %}
                        </div>
                      </a>
                      {% endfor %}
                      
                      {% for note in module.notes_set.all %}
                      <a href="{% url 'courseviewpagenote' course_id=course.id note_id=note.id %}" class="list-group-item list-group-item-action d-flex align-items-center py-3 px-3 hover-bg">
                        <div class="flex-shrink-0 me-3">
                          <div class="note-icon bg-info text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 36px; height: 36px;">
                            <i class="fas fa-file-alt"></i>
                          </div>
                        </div>
                        <div class="flex-grow-1">
                          <h6 class="mb-1">ملاحظات</h6>
                          <p class="text-muted mb-0 small">مواد تعليمية إضافية</p>
                        </div>
                        <div class="ms-auto">
                          <i class="fas fa-chevron-right text-muted"></i>
                        </div>
                      </a>
                      {% endfor %}
                      
                      {% for quiz in module.module_quizzes.all %}
                      <div class="list-group-item d-flex align-items-center py-3 px-3 hover-bg">
                        <div class="flex-shrink-0 me-3">
                          <div class="quiz-icon bg-warning text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 36px; height: 36px;">
                            <i class="fas fa-question"></i>
                          </div>
                        </div>
                        <div class="flex-grow-1">
                          <h6 class="mb-1">{{ quiz.title|default:"اختبار الوحدة" }}</h6>
                          <p class="text-muted mb-0 small">{{ quiz.question_set.count }} أسئلة • {{ quiz.pass_mark }}% للنجاح</p>
                        </div>
                        <div class="ms-auto">
                          <button class="btn btn-sm btn-outline-primary rounded-pill">بدء الاختبار</button>
                        </div>
                      </div>
                      {% endfor %}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
      {% endfor %}

      <!-- Discussion Section -->
      <section class="mt-5">
        <div class="card border-0 shadow-sm">
          <div class="card-header bg-white py-3 border-bottom">
            <h4 class="mb-0 d-flex align-items-center">
              <i class="fas fa-comments text-primary me-2"></i>منتدى النقاش
              <span class="badge bg-primary ms-2">{{ course.comment_set.count }}</span>
            </h4>
          </div>
          
          <div class="card-body">
            <!-- New Comment Form -->
            <form method="post" action="{% url 'add_comment' course_id=course.id %}" class="mb-4 comment-form">
              {% csrf_token %}
              <div class="form-floating mb-3">
                <textarea class="form-control" placeholder="اكتب سؤالك أو تعليقك هنا" id="commentTextarea" name="comment_text" style="height: 100px" required></textarea>
                <label for="commentTextarea">اكتب سؤالك أو تعليقك هنا</label>
              </div>
              <div class="text-end">
                <button type="submit" class="btn btn-primary rounded-pill px-4 py-2 shadow-sm">
                  <i class="fas fa-paper-plane me-2"></i>إرسال
                </button>
              </div>
            </form>
            
            <!-- Comments List -->
            <div class="comments-list">
              {% if course.comment_set.all %}
                {% for comment in course.comment_set.all %}
                <div class="comment-item mb-4 p-3 border-bottom">
                  <div class="d-flex">
                    <div class="flex-shrink-0">
                      {% if comment.user.profile.image %}
                        <img src="{{ comment.user.profile.image.url }}" alt="{{ comment.user.profile.name }}" class="rounded-circle me-3" width="48" height="48">
                      {% else %}
                        <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-3" style="width: 48px; height: 48px;">
                          {{ comment.user.profile.name|slice:':1'|upper }}
                        </div>
                      {% endif %}
                    </div>
                    <div class="flex-grow-1">
                      <h6 class="mb-0">{{ comment.user.profile.name }}</h6>
                      <small class="text-muted">{{ comment.created_at|date:"d M Y" }}</small>
                      <div class="comment-content mt-2">
                        {{ comment.description|safe }}
                      </div>
                    </div>
                  </div>
                </div>
                {% endfor %}
              {% else %}
                <p class="text-center">لا يوجد تعليقات بعد.</p>
              {% endif %}
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>
</main>

{% endblock content %}
