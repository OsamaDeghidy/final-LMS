{% extends 'main/dashboard_base.html' %}
{% load static %}

{% block title %}تحديث الدورة{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/course-creation.css' %}">
<script src="{% static 'js/course-image-upload.js' %}"></script>
<script src="{% static 'js/course-creation.js' %}"></script>
<script src="{% static 'js/course-update.js' %}"></script>
<style>
  .bg-danger-light {
    background-color: rgba(220, 53, 69, 0.1);
  }
</style>
{% endblock %}

{% block dashboard_content %}
    <div class="col-lg-8">
      <div class="card shadow-lg border-0 mb-5">
        <div class="card-header text-white" style="background: linear-gradient(135deg, #1d3b53 0%, #2a5a7c 100%);">
          <h2 class="mb-0 text-center">
            <i class="fas fa-edit me-2"></i> تحديث الدورة
          </h2>
        </div>
        <div class="card-body p-4">
          <!-- Django Messages -->
          {% if messages %}
          <div class="messages-container mb-4">
            {% for message in messages %}
              <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            {% endfor %}
          </div>
          {% endif %}
          
          <form id="course-form" method="post" enctype="multipart/form-data" class="needs-validation" action="{% url 'update_course' course.id %}" novalidate>
            {% csrf_token %}
            <!-- Hidden input for modules data -->
            <input type="hidden" name="modules" id="modules_data" value="">
            
            <!-- Step Progress Bar -->
            <div id="stepper" class="d-flex justify-content-between mb-5">
              <div class="step-line"></div>
              <div class="step-item active">
                <div class="step-circle">1</div>
                <div class="text-center mt-2">معلومات الدورة</div>
              </div>
              <div class="step-item">
                <div class="step-circle">2</div>
                <div class="text-center mt-2">الموديولات</div>
              </div>
              <div class="step-item">
                <div class="step-circle">3</div>
                <div class="text-center mt-2">المراجعة</div>
              </div>
            </div>
            
            
            <!-- Step 1: Course Info -->
            <div class="step-card">
              <h4 class="mb-4 text-primary">معلومات الدورة الأساسية</h4>
              
              <div class="mb-3">
                <label class="form-label fw-bold">عنوان الدورة</label>
                <div class="input-group">
                  <span class="input-group-text bg-light"><i class="fas fa-book text-primary"></i></span>
                  <input type="text" class="form-control" name="name" required placeholder="أدخل عنوان الدورة" value="{{ course.name }}">
                </div>
              </div>
              
              <div class="mb-3">
                <label class="form-label fw-bold">وصف مختصر</label>
                <div class="input-group">
                  <span class="input-group-text bg-light"><i class="fas fa-align-left text-primary"></i></span>
                  <input type="text" class="form-control" name="small_description" placeholder="ملخص يظهر في بطاقة الدورة" value="{{ course.small_description }}">
                </div>
              </div>
              
              <div class="row mb-3">
                <div class="col-md-6">
                  <label class="form-label fw-bold">السعر ($)</label>
                  <div class="input-group">
                    <span class="input-group-text bg-light">$</span>
                    <input type="number" class="form-control" name="price" step="0.01" min="0" placeholder="0.00" required value="{{ course.price }}">
                  </div>
                </div>
                <div class="col-md-6">
                  <label class="form-label fw-bold">مستوى الدورة</label>
                  <select class="form-select" name="level" required>
                    <option value="">-- اختر المستوى --</option>
                    <option value="beginner" {% if course.level == "beginner" %}selected{% endif %}>مبتدئ</option>
                    <option value="intermediate" {% if course.level == "intermediate" %}selected{% endif %}>متوسط</option>
                    <option value="advanced" {% if course.level == "advanced" %}selected{% endif %}>متقدم</option>
                  </select>
                </div>
              </div>
              
              <div class="mb-3">
                <label class="form-label fw-bold">صورة الدورة</label>
                {% if course.image_course %}
                  <div class="mb-2">
                    <img src="{{ course.image_course.url }}" class="img-thumbnail" style="max-width: 200px;">
                  </div>
                {% endif %}
                <div class="card border-dashed p-3 text-center" style="cursor: pointer;" onclick="document.getElementById('image_course').click()">
                  <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-2"></i>
                  <h5 class="text-muted">انقر لتغيير الصورة</h5>
                  <p class="small text-muted">الحجم الموصى به: 800x450 بكسل</p>
                  <input type="file" class="d-none" id="image_course" name="image_course" accept="image/*">
                </div>
              </div>
              
              <div class="mb-3">
                <label class="form-label fw-bold">الوصف التفصيلي</label>
                <textarea class="form-control" name="description" rows="5" required placeholder="اشرح محتوى الدورة بشكل تفصيلي...">{{ course.description }}</textarea>
              </div>
              
              <div class="mb-3">
                <label class="form-label fw-bold">ما الذي سيتعلمه الطالب؟</label>
                <textarea class="form-control" name="learned" rows="5" placeholder="أدخل كل نقطة في سطر منفصل...">{{ course.learned }}</textarea>
                <div class="form-text">ضع كل نقطة تعلم في سطر جديد</div>
              </div>

              <!-- PDF Files Section -->
              <div class="card mb-4 border-primary">
                <div class="card-header bg-light">
                  <h5 class="mb-0"><i class="fas fa-file-pdf text-danger me-2"></i>ملفات PDF للدورة</h5>
                </div>
                <div class="card-body">
                  <div class="row">
                    <!-- Syllabus PDF -->
                    <div class="col-md-6 mb-3">
                      <label class="form-label fw-bold">منهج الدورة التفصيلي (PDF)</label>
                      {% if course.syllabus_pdf %}
                      <div class="mb-2">
                        <div class="d-flex align-items-center p-2 bg-light rounded">
                          <i class="fas fa-file-pdf text-danger me-2 fa-lg"></i>
                          <div class="flex-grow-1 text-truncate">{{ course.syllabus_pdf.name }}</div>
                          <a href="{% url 'delete_pdf' course.id 'syllabus_pdf' %}" class="btn btn-sm btn-danger" onclick="return confirm('هل أنت متأكد من حذف هذا الملف؟')">
                            <i class="fas fa-trash"></i> حذف
                          </a>
                        </div>
                      </div>
                      {% endif %}
                      <input type="file" class="form-control" name="syllabus_pdf" accept="application/pdf">
                      <small class="text-muted">اختياري. حجم الملف الأقصى: 10 ميجابايت</small>
                    </div>
                    
                    <!-- Materials PDF -->
                    <div class="col-md-6 mb-3">
                      <label class="form-label fw-bold">مواد إضافية للدورة (PDF)</label>
                      {% if course.materials_pdf %}
                      <div class="mb-2">
                        <div class="d-flex align-items-center p-2 bg-light rounded">
                          <i class="fas fa-file-pdf text-danger me-2 fa-lg"></i>
                          <div class="flex-grow-1 text-truncate">{{ course.materials_pdf.name }}</div>
                          <a href="{% url 'delete_pdf' course.id 'materials_pdf' %}" class="btn btn-sm btn-danger" onclick="return confirm('هل أنت متأكد من حذف هذا الملف؟')">
                            <i class="fas fa-trash"></i> حذف
                          </a>
                        </div>
                      </div>
                      {% endif %}
                      <input type="file" class="form-control" name="materials_pdf" accept="application/pdf">
                      <small class="text-muted">اختياري. حجم الملف الأقصى: 10 ميجابايت</small>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="row mb-3">
                <div class="col-md-6">
                  <label class="form-label fw-bold">فئة الدورة</label>
                  <select class="form-select" name="category">
                    <option value="">-- اختر الفئة --</option>
                    {% for cat in categories %}
                      <option value="{{ cat.id }}" {% if course.category.id == cat.id %}selected{% endif %}>{{ cat.name }}</option>
                    {% endfor %}
                  </select>
                </div>
                <!-- <div class="col-md-6">
                  <label class="form-label fw-bold">المؤسسة</label>
                  <select class="form-select" name="organization">
                    <option value="">-- اختر المؤسسة --</option>
                    {% for org in organizations %}
                      <option value="{{ org.id }}" {% if course.organization.id == org.id %}selected{% endif %}>{{ org.name }}</option>
                    {% endfor %}
                  </select>
                </div> -->
              </div>
              
              <div class="mb-3">
                <label class="form-label fw-bold">وسوم الدورة</label>
                <div class="input-group">
                  <span class="input-group-text bg-light"><i class="fas fa-tags text-primary"></i></span>
                  <input type="text" class="form-control" name="tags" placeholder="برمجة، تطوير، تصميم (افصل بينهم بفاصلة)" value="{{ tags_string }}">
                </div>
              </div>
              
              <div class="d-flex justify-content-end mt-4">
                <button type="button" class="btn btn-primary px-4" onclick="nextStep()">
                  التالي <i class="fas fa-arrow-left ms-2"></i>
                </button>
              </div>
            </div>
            
            <!-- Step 2: Modules -->
            <div class="step-card d-none">
              <h4 class="mb-4 text-primary">موديولات الدورة</h4>
              
              <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                قم بإدارة موديولات الدورة. يمكنك تعديل أو حذف الموديولات الحالية وإضافة موديولات جديدة. كل موديول يمكن أن يحتوي على فيديوهات وملفات PDF وملاحظات واختبارات.
              </div>
              
              <div id="modules-container">
                <!-- Existing Modules -->
                {% for module in course.module_set.all %}
                <div class="card mb-4 module-card" id="existing_module_{{ module.id }}">
                  <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-layer-group text-primary me-2"></i>الموديول {{ module.number }}</h5>
                    <button type="button" class="btn btn-sm btn-outline-danger remove-module-btn" data-module-id="{{ module.id }}">
                      <i class="fas fa-trash"></i>
                    </button>
                    <input type="hidden" name="delete_module_{{ module.id }}" id="delete_module_{{ module.id }}" value="0">
                  </div>
                  <div class="card-body">
                    <!-- Module Info -->
                    <div class="mb-3">
                      <label class="form-label fw-bold">اسم الموديول</label>
                      <input type="text" class="form-control" name="module_name_existing_{{ module.id }}" placeholder="أدخل اسم الموديول" value="{{ module.name }}" required>
                      <input type="hidden" name="module_id_existing_{{ module.id }}" value="{{ module.id }}">
                    </div>
                    
                    <!-- Videos -->
                    <div class="card mb-3">
                      <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="fas fa-video me-2"></i>الفيديوهات</h6>
                      </div>
                      <div class="card-body">
                        <!-- Existing Videos -->
                        <div class="mb-3">
                          <label class="form-label fw-bold">الفيديوهات الحالية</label>
                          <div class="list-group mb-3">
                            {% for video in module.video_set.all %}
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                              <div>
                                <i class="fas fa-video text-primary me-2"></i>
                                {{ video.name }}
                              </div>
                              <div class="form-check">
                                <input class="form-check-input delete-checkbox" type="checkbox" name="delete_video_{{ video.id }}" id="delete_video_{{ video.id }}" value="1">
                                <label class="form-check-label text-danger" for="delete_video_{{ video.id }}">
                                  حذف
                                </label>
                              </div>
                            </div>
                            {% empty %}
                            <div class="list-group-item text-muted">لا توجد فيديوهات</div>
                            {% endfor %}
                          </div>
                        </div>
                        <!-- New Video -->
                        <div class="mb-3">
                          <label class="form-label fw-bold">تحميل فيديو جديد</label>
                          <input type="file" class="form-control" name="module_videos_existing_{{ module.id }}" accept=".mp4,.mov,.avi">
                          <small class="text-muted">الصيغ المدعومة: MP4, MOV, AVI (الحد الأقصى: 500MB)</small>
                        </div>
                        <div class="mb-3">
                          <label class="form-label fw-bold">عنوان الفيديو</label>
                          <input type="text" class="form-control" name="video_name_existing_{{ module.id }}_0" placeholder="أدخل عنوان الفيديو">
                        </div>
                      </div>
                    </div>

                    <!-- PDF Section -->
                    <div class="card mb-3">
                      <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="fas fa-file-pdf me-2"></i>الملف المرفق</h6>
                      </div>
                      <div class="card-body">
                        <!-- Existing PDFs -->
                        <div class="mb-3">
                          <label class="form-label fw-bold">الملفات الحالية</label>
                          {% if module.module_pdf %}
                          <div class="list-group mb-3">
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                              <div>
                                <i class="fas fa-file-pdf text-danger me-2"></i>
                                {{ module.module_pdf.name }}
                              </div>
                              <button type="button" class="btn btn-sm btn-danger delete-module-pdf" data-module-id="{{ module.id }}" data-pdf-type="module_pdf">
                                <i class="fas fa-trash"></i>
                              </button>
                            </div>
                          </div>
                          {% else %}
                          <div class="text-muted mb-3">لا توجد ملفات PDF</div>
                          {% endif %}
                        </div>
                        <!-- New PDF -->
                        <div class="mb-3">
                          <label class="form-label fw-bold">تحميل ملف PDF</label>
                          <input type="file" class="form-control" name="module_pdf_existing_{{ module.id }}" accept=".pdf">
                          <small class="text-muted">حجم الملف الأقصى: 20MB</small>
                        </div>
                        <div class="mb-3">
                          <label class="form-label fw-bold">عنوان الملف</label>
                          <input type="text" class="form-control pdf-title" name="pdf_title_existing_{{ module.id }}" placeholder="أدخل عنوان الملف">
                        </div>
                      </div>
                    </div>
                    
                    <!-- Notes Section -->
                    <div class="card mb-3">
                      <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="fas fa-sticky-note me-2"></i>ملاحظات إضافية</h6>
                      </div>
                      <div class="card-body">
                        <!-- Existing Notes -->
                        <div class="mb-3">
                          <label class="form-label fw-bold">الملاحظات الحالية</label>
                          <div class="list-group mb-3">
                            {% for note in module.notes_set.all %}
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                              <div>
                                <i class="fas fa-sticky-note text-primary me-2"></i>
                                {{ note.description|truncatechars:50 }}
                              </div>
                              <div class="form-check">
                                <input class="form-check-input delete-checkbox" type="checkbox" name="delete_note_{{ note.id }}" id="delete_note_{{ note.id }}" value="1">
                                <label class="form-check-label text-danger" for="delete_note_{{ note.id }}">
                                  حذف
                                </label>
                              </div>
                            </div>
                            {% empty %}
                            <div class="list-group-item text-muted">لا توجد ملاحظات</div>
                            {% endfor %}
                          </div>
                        </div>
                        <!-- New Note -->
                        <div class="mb-3">
                          <label class="form-label fw-bold">ملاحظات الموديول</label>
                          <textarea class="form-control" name="module_notes_existing_{{ module.id }}_0" rows="3" placeholder="أضف ملاحظات إضافية عن الموديول"></textarea>
                        </div>
                      </div>
                    </div>
                    

                    <!-- Quiz Section -->
                    <div class="card mb-3">
                      <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="fas fa-question-circle me-2"></i>اختبار الموديول</h6>
                        <div class="form-check form-switch">
                          <input class="form-check-input quiz-toggle" type="checkbox" id="has_quiz_existing_{{ module.id }}" name="has_quiz_existing_{{ module.id }}" {% if module.module_quizzes.first %}checked{% endif %} onchange="toggleQuiz(this.closest('.card'), this.checked)">
                          <label class="form-check-label" for="has_quiz_existing_{{ module.id }}">إضافة اختبار</label>
                        </div>
                      </div>
                      <div class="card-body quiz-section" id="quiz_section_existing_{{ module.id }}" {% if not module.module_quizzes.first %}style="display: none;"{% endif %}>
                        <div class="questions-container">
                          <!-- Existing Questions -->
                          {% if module.module_quizzes.first %}
                          {% for question in module.module_quizzes.first.questions.all %}
                          <div class="question-card card mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                              <span>سؤال {{ forloop.counter }}</span>
                              <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeQuestion(this.closest('.question-card'))">
                                <i class="fas fa-trash"></i>
                              </button>
                            </div>
                            <div class="card-body">
                              <div class="mb-3">
                                <label class="form-label">نص السؤال</label>
                                <input type="text" class="form-control question-text" name="question_text_existing_{{ module.id }}_{{ forloop.counter0 }}" value="{{ question.text }}" required>
                              </div>
                              <div class="mb-3">
                                <label class="form-label">نوع السؤال</label>
                                <select class="form-select question-type" name="question_type_existing_{{ module.id }}_{{ forloop.counter0 }}" onchange="updateQuestionType(this)">
                                  <option value="mcq" {% if question.question_type == 'multiple_choice' %}selected{% endif %}>اختيار من متعدد</option>
                                  <option value="true_false" {% if question.question_type == 'true_false' %}selected{% endif %}>صح / خطأ</option>
                                  <option value="short_answer" {% if question.question_type == 'short_answer' %}selected{% endif %}>إجابة قصيرة</option>
                                </select>
                              </div>
                              <div class="answers-container">
                                {% for answer in question.answers.all %}
                                <div class="answer-item mb-2">
                                  <div class="input-group">
                                    <div class="input-group-text">
                                      <input class="form-check-input mt-0" type="radio" name="correct_answer_existing_{{ module.id }}_{{ forloop.parentloop.counter0 }}" value="{{ forloop.counter0 }}" {% if answer.is_correct %}checked{% endif %}>
                                    </div>
                                    <input type="text" class="form-control" name="answer_text_existing_{{ module.id }}_{{ forloop.parentloop.counter0 }}_{{ forloop.counter0 }}" value="{{ answer.text }}" required>
                                    <button type="button" class="btn btn-outline-danger" onclick="removeAnswer(this.closest('.answer-item'))">
                                      <i class="fas fa-times"></i>
                                    </button>
                                  </div>
                                </div>
                                {% endfor %}
                              </div>
                              <div class="mt-2">
                                <small class="text-muted">انقر على الإجابة الصحيحة لتحديدها</small>
                              </div>
                            </div>
                          </div>
                          {% endfor %}
                          {% endif %}
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="addQuestion(this.closest('.module-card'))">
                          <i class="fas fa-plus me-1"></i>إضافة سؤال
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>
              
              <div class="d-flex justify-content-center my-4">
                <button type="button" class="btn btn-success" id="add-module-btn">
                  <i class="fas fa-plus me-2"></i> إضافة موديول جديد
                </button>
              </div>
              
              <div class="d-flex justify-content-between mt-4">
                <button type="button" class="btn btn-outline-secondary px-4" onclick="prevStep()">
                  <i class="fas fa-arrow-right me-2"></i> السابق
                </button>
                <button type="button" class="btn btn-primary px-4" onclick="nextStep()">
                  التالي <i class="fas fa-arrow-left ms-2"></i>
                </button>
              </div>
            </div>
            
            <!-- Step 3: Review -->
            <div class="step-card d-none">
              <h4 class="mb-4 text-primary">مراجعة الدورة</h4>
              
              <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                راجع معلومات الدورة قبل الحفظ. تأكد من إضافة جميع المعلومات المطلوبة.
              </div>
              
              <div class="course-summary mb-4">
                <h5 class="text-primary mb-3">ملخص الدورة</h5>
                <div class="card">
                  <div class="card-body">
                    <p><strong>عنوان الدورة:</strong> <span id="summary-title"></span></p>
                    <p><strong>الوصف المختصر:</strong> <span id="summary-small-desc"></span></p>
                    <p><strong>السعر:</strong> <span id="summary-price"></span></p>
                    <p><strong>المستوى:</strong> <span id="summary-level"></span></p>
                    <p><strong>عدد الموديولات:</strong> <span id="summary-modules"></span></p>
                  </div>
                </div>
              </div>
              
              <div class="d-flex justify-content-between mt-4">
                <button type="button" class="btn btn-outline-secondary px-4" onclick="prevStep()">
                  <i class="fas fa-arrow-right me-2"></i> السابق
                </button>
                <button type="button" class="btn btn-success px-4" id="submit-course-btn">
                  <i class="fas fa-save me-2"></i> حفظ التغييرات
                </button>
              </div>
            </div>
            
          </form>
        </div>
      </div>
    </div>

<script>
// Initialize when document is ready
document.addEventListener('DOMContentLoaded', function() {
    // Initialize existing functionality
    initializeExistingModules();
    
    // Add module button handler
    document.getElementById('add-module-btn').addEventListener('click', addNewModule);
    
    // Submit form handler
    document.getElementById('submit-course-btn').addEventListener('click', submitForm);
    
    // Initialize quiz toggles
    initializeQuizToggles();
});

function initializeExistingModules() {
    // Initialize existing module functionality
    document.querySelectorAll('.remove-module-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const moduleId = this.getAttribute('data-module-id');
            if (confirm('هل أنت متأكد من حذف هذا الموديول؟')) {
                document.getElementById(`delete_module_${moduleId}`).value = '1';
                document.getElementById(`existing_module_${moduleId}`).style.display = 'none';
            }
        });
    });
    
    // Initialize PDF deletion buttons
    document.querySelectorAll('.delete-module-pdf').forEach(btn => {
        btn.addEventListener('click', function() {
            const moduleId = this.getAttribute('data-module-id');
            const pdfType = this.getAttribute('data-pdf-type');
            if (confirm('هل أنت متأكد من حذف هذا الملف؟')) {
                window.location.href = `/delete-module-pdf/${moduleId}/${pdfType}/`;
            }
        });
    });
    
    // Initialize note and video name buttons
    initializeNoteButtons();
    initializeVideoNameButtons();
    initializeQuestionButtons();
}

function initializeQuizToggles() {
    document.querySelectorAll('.quiz-toggle').forEach(toggle => {
        toggle.addEventListener('change', function() {
            const moduleId = this.id.replace('has_quiz_existing_', '').replace('has_quiz_new_', '');
            const quizSection = document.getElementById(`quiz_section_existing_${moduleId}`) || 
                               document.getElementById(`quiz_section_new_${moduleId}`);
            
            if (quizSection) {
                if (this.checked) {
                    quizSection.classList.remove('d-none');
                } else {
                    quizSection.classList.add('d-none');
                }
            }
        });
    });
}

function addNewModule() {
    moduleCounter++;
    const moduleId = `new_${Date.now()}_${moduleCounter}`;
    
    const moduleHtml = `
        <div class="card mb-4 module-card" id="new_module_${moduleId}">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-layer-group text-primary me-2"></i>موديول جديد</h5>
                <button type="button" class="btn btn-sm btn-outline-danger remove-new-module-btn" data-module-id="${moduleId}">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            <div class="card-body">
                <!-- Module Info -->
                <div class="mb-3">
                    <label class="form-label fw-bold">اسم الموديول</label>
                    <input type="text" class="form-control" name="module_name_new_${moduleId}" placeholder="أدخل اسم الموديول" required>
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">وصف الموديول</label>
                    <textarea class="form-control" name="module_description_new_${moduleId}" rows="3" placeholder="وصف الموديول"></textarea>
                </div>
                
                <!-- Videos and PDFs -->
                <div class="mb-3">
                  <label class="form-label fw-bold">تحميل الفيديوهات</label>
                  <input type="file" class="form-control mb-2" name="module_videos_${moduleId}" accept="video/*" multiple>
                  <small class="text-muted d-block mb-3">الصيغ المدعومة: MP4, MOV, AVI</small>
                  
                  <label class="form-label fw-bold">تحميل ملفات PDF</label>
                  <input type="file" class="form-control" name="module_pdfs_${moduleId}" accept=".pdf" multiple>
                  <small class="text-muted">يمكنك تحميل ملفات PDF متعددة</small>
                  
                  {% if module.pdf_files.all %}
                  <div class="mt-3">
                    <label class="form-label fw-bold">ملفات PDF الحالية:</label>
                    <div class="list-group">
                      {% for pdf in module.pdf_files.all %}
                      <div class="list-group-item d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-file-pdf text-danger me-2"></i>{{ pdf.title }}</span>
                        <button type="button" class="btn btn-sm btn-outline-danger remove-pdf-btn" data-pdf-id="{{ pdf.id }}">
                          <i class="fas fa-times"></i>
                        </button>
                      </div>
                      {% endfor %}
                    </div>
                  </div>
                  {% endif %}
                </div>
                
                <!-- Module PDFs Section -->
                <div class="card mb-3 border-info">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="fas fa-file-pdf text-danger me-2"></i>ملفات PDF للموديول</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Module PDF -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">ملف PDF رئيسي للموديول</label>
                                <input type="file" class="form-control" name="module_pdf_new_${moduleId}" accept="application/pdf">
                                <small class="text-muted">اختياري. ملف PDF يحتوي على محتوى الموديول</small>
                            </div>
                            
                            <!-- Additional Materials -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">مواد إضافية (PDF)</label>
                                <input type="file" class="form-control" name="additional_materials_new_${moduleId}" accept="application/pdf">
                                <small class="text-muted">اختياري. مواد إضافية للموديول</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Video Names -->
                <div class="mb-3">
                    <label class="form-label fw-bold">عناوين الفيديوهات</label>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div></div>
                        <button type="button" class="btn btn-sm btn-outline-primary add-video-name-btn" data-module-id="new_${moduleId}">
                            <i class="fas fa-plus me-1"></i>إضافة عنوان
                        </button>
                    </div>
                    <div class="video-names-container" id="video_names_container_new_${moduleId}">
                        <div class="input-group mb-2">
                            <span class="input-group-text bg-light"><i class="fas fa-video text-primary"></i></span>
                            <input type="text" class="form-control" name="video_name_new_${moduleId}_0" placeholder="أدخل عنوان الفيديو">
                            <button type="button" class="btn btn-outline-danger remove-video-name-btn">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Notes -->
                <div class="mb-3">
                    <label class="form-label fw-bold">ملاحظات</label>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div></div>
                        <button type="button" class="btn btn-sm btn-outline-primary add-note-btn" data-module-id="new_${moduleId}">
                            <i class="fas fa-plus me-1"></i>إضافة ملاحظة
                        </button>
                    </div>
                    <div class="notes-container" id="notes_container_new_${moduleId}">
                        <div class="input-group mb-2">
                            <textarea class="form-control" name="module_notes_new_${moduleId}_0" rows="2" placeholder="أدخل ملاحظة"></textarea>
                            <button type="button" class="btn btn-outline-danger remove-note-btn">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Quiz Section -->
                <div class="card mb-3 border-primary">
                    <div class="card-header bg-light">
                        <div class="form-check form-switch">
                            <input class="form-check-input quiz-toggle" type="checkbox" id="has_quiz_new_${moduleId}" name="has_quiz_new_${moduleId}">
                            <label class="form-check-label fw-bold" for="has_quiz_new_${moduleId}">إضافة اختبار للموديول</label>
                        </div>
                    </div>
                    <div class="quiz-section card-body d-none" id="quiz_section_new_${moduleId}">
                        <div class="mb-3">
                            <label class="form-label fw-bold">عنوان الاختبار</label>
                            <input type="text" class="form-control" name="quiz_title_new_${moduleId}" placeholder="أدخل عنوان الاختبار">
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">وصف الاختبار</label>
                            <textarea class="form-control" name="quiz_description_new_${moduleId}" rows="2" placeholder="وصف مختصر للاختبار"></textarea>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">درجة النجاح (%)</label>
                                <input type="number" class="form-control" name="quiz_pass_mark_new_${moduleId}" min="0" max="100" value="50">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">مدة الاختبار (دقائق)</label>
                                <input type="number" class="form-control" name="quiz_time_limit_new_${moduleId}" min="1" value="10">
                            </div>
                        </div>
                        
                        <div class="questions-container" id="questions_container_new_${moduleId}">
                            <!-- Questions will be added here -->
                        </div>
                        
                        <button type="button" class="btn btn-primary w-100 mt-3 add-question-btn" data-module-id="new_${moduleId}">
                            <i class="fas fa-plus me-1"></i>إضافة سؤال جديد
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('modules-container').insertAdjacentHTML('beforeend', moduleHtml);
    
    // Initialize new module functionality
    initializeNewModuleEvents(moduleId);
}

function initializeNewModuleEvents(moduleId) {
    // Remove module button
    document.querySelector(`[data-module-id="${moduleId}"]`).addEventListener('click', function() {
        if (confirm('هل أنت متأكد من حذف هذا الموديول؟')) {
            document.getElementById(`new_module_${moduleId}`).remove();
        }
    });
    
    // Quiz toggle
    document.getElementById(`has_quiz_new_${moduleId}`).addEventListener('change', function() {
        const quizSection = document.getElementById(`quiz_section_new_${moduleId}`);
        if (this.checked) {
            quizSection.classList.remove('d-none');
        } else {
            quizSection.classList.add('d-none');
        }
    });
    
    // Initialize buttons for this module
    initializeNoteButtons();
    initializeVideoNameButtons();
    initializeQuestionButtons();
}

function initializeNoteButtons() {
    document.querySelectorAll('.add-note-btn').forEach(btn => {
        btn.removeEventListener('click', addNoteHandler);
        btn.addEventListener('click', addNoteHandler);
    });
    
    document.querySelectorAll('.remove-note-btn').forEach(btn => {
        btn.removeEventListener('click', removeNoteHandler);
        btn.addEventListener('click', removeNoteHandler);
    });
}

function addNoteHandler() {
    const moduleId = this.getAttribute('data-module-id');
    const container = document.getElementById(`notes_container_${moduleId}`);
    const noteCount = container.children.length;
    
    const noteHtml = `
        <div class="input-group mb-2">
            <textarea class="form-control" name="module_notes_${moduleId}_${noteCount}" rows="2" placeholder="أدخل ملاحظة"></textarea>
            <button type="button" class="btn btn-outline-danger remove-note-btn">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', noteHtml);
    initializeNoteButtons();
}

function removeNoteHandler() {
    this.closest('.input-group').remove();
}

function initializeVideoNameButtons() {
    document.querySelectorAll('.add-video-name-btn').forEach(btn => {
        btn.removeEventListener('click', addVideoNameHandler);
        btn.addEventListener('click', addVideoNameHandler);
    });
    
    document.querySelectorAll('.remove-video-name-btn').forEach(btn => {
        btn.removeEventListener('click', removeVideoNameHandler);
        btn.addEventListener('click', removeVideoNameHandler);
    });
}

function addVideoNameHandler() {
    const moduleId = this.getAttribute('data-module-id');
    const container = document.getElementById(`video_names_container_${moduleId}`);
    const nameCount = container.children.length;
    
    const nameHtml = `
        <div class="input-group mb-2">
            <span class="input-group-text bg-light"><i class="fas fa-video text-primary"></i></span>
            <input type="text" class="form-control" name="video_name_${moduleId}_${nameCount}" placeholder="أدخل عنوان الفيديو">
            <button type="button" class="btn btn-outline-danger remove-video-name-btn">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', nameHtml);
    initializeVideoNameButtons();
}

function removeVideoNameHandler() {
    this.closest('.input-group').remove();
}

function initializeQuestionButtons() {
    document.querySelectorAll('.add-question-btn').forEach(btn => {
        btn.removeEventListener('click', addQuestionHandler);
        btn.addEventListener('click', addQuestionHandler);
    });
}

function addQuestionHandler() {
    const moduleId = this.getAttribute('data-module-id');
    const container = document.getElementById(`questions_container_${moduleId}`);
    const questionCount = container.children.length;
    questionCounter++;
    
    const questionHtml = `
        <div class="card mb-3 question-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">سؤال #${questionCount + 1}</h6>
                    <button type="button" class="btn btn-sm btn-outline-danger remove-question-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="mb-3">
                    <input type="text" class="form-control" name="question_text_${moduleId}_${questionCounter}" placeholder="نص السؤال" required>
                </div>
                
                <div class="mb-3">
                    <select class="form-select question-type-select" name="question_type_${moduleId}_${questionCounter}">
                        <option value="multiple_choice">اختيار من متعدد</option>
                        <option value="true_false">صح أو خطأ</option>
                        <option value="short_answer">إجابة قصيرة</option>
                    </select>
                </div>
                
                <div class="answers-container" id="answers_${moduleId}_${questionCounter}">
                    <div class="answer-item mb-2">
                        <div class="input-group">
                            <div class="input-group-text">
                                <input class="form-check-input mt-0" type="radio" name="correct_answer_${moduleId}_${questionCounter}" value="0" checked>
                            </div>
                            <input type="text" class="form-control" name="answer_text_${moduleId}_${questionCounter}_0" placeholder="الإجابة 1" required>
                            <button type="button" class="btn btn-sm btn-outline-danger remove-answer-btn">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="answer-item mb-2">
                        <div class="input-group">
                            <div class="input-group-text">
                                <input class="form-check-input mt-0" type="radio" name="correct_answer_${moduleId}_${questionCounter}" value="1">
                            </div>
                            <input type="text" class="form-control" name="answer_text_${moduleId}_${questionCounter}_1" placeholder="الإجابة 2" required>
                            <button type="button" class="btn btn-sm btn-outline-danger remove-answer-btn">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <button type="button" class="btn btn-sm btn-outline-primary mt-2 add-answer-btn">
                    <i class="fas fa-plus me-1"></i>إضافة إجابة
                </button>
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', questionHtml);
    
    // Initialize question events
    const questionCard = container.lastElementChild;
    initializeQuestionEvents(questionCard, moduleId, questionCounter);
}

function initializeQuestionEvents(questionCard, moduleId, questionIndex) {
    // Remove question button
    questionCard.querySelector('.remove-question-btn').addEventListener('click', function() {
        if (confirm('هل أنت متأكد من حذف هذا السؤال؟')) {
            questionCard.remove();
        }
    });
    
    // Question type change
    questionCard.querySelector('.question-type-select').addEventListener('change', function() {
        updateAnswersForQuestionType(this.value, moduleId, questionIndex);
    });
    
    // Add answer button
    questionCard.querySelector('.add-answer-btn').addEventListener('click', function() {
        addAnswerToQuestion(moduleId, questionIndex);
    });
    
    // Remove answer buttons
    questionCard.querySelectorAll('.remove-answer-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            this.closest('.answer-item').remove();
        });
    });
}

function updateAnswersForQuestionType(questionType, moduleId, questionIndex) {
    const answersContainer = document.getElementById(`answers_${moduleId}_${questionIndex}`);
    
    if (questionType === 'true_false') {
        answersContainer.innerHTML = `
            <div class="answer-item mb-2">
                <div class="input-group">
                    <div class="input-group-text">
                        <input class="form-check-input mt-0" type="radio" name="correct_answer_${moduleId}_${questionIndex}" value="0" checked>
                    </div>
                    <input type="text" class="form-control" name="answer_text_${moduleId}_${questionIndex}_0" value="صح" readonly>
                </div>
            </div>
            <div class="answer-item mb-2">
                <div class="input-group">
                    <div class="input-group-text">
                        <input class="form-check-input mt-0" type="radio" name="correct_answer_${moduleId}_${questionIndex}" value="1">
                    </div>
                    <input type="text" class="form-control" name="answer_text_${moduleId}_${questionIndex}_1" value="خطأ" readonly>
                </div>
            </div>
        `;
    } else if (questionType === 'short_answer') {
        answersContainer.innerHTML = `
            <div class="mb-3">
                <label class="form-label">الإجابة الصحيحة</label>
                <input type="text" class="form-control" name="answer_short_${moduleId}_${questionIndex}" placeholder="أدخل الإجابة الصحيحة" required>
            </div>
        `;
    }
}

function addAnswerToQuestion(moduleId, questionIndex) {
    const answersContainer = document.getElementById(`answers_${moduleId}_${questionIndex}`);
    const answerCount = answersContainer.children.length;
    
    const answerHtml = `
        <div class="answer-item mb-2">
            <div class="input-group">
                <div class="input-group-text">
                    <input class="form-check-input mt-0" type="radio" name="correct_answer_${moduleId}_${questionIndex}" value="${answerCount}">
                </div>
                <input type="text" class="form-control" name="answer_text_${moduleId}_${questionIndex}_${answerCount}" placeholder="الإجابة ${answerCount + 1}" required>
                <button type="button" class="btn btn-sm btn-outline-danger remove-answer-btn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    `;
    
    answersContainer.insertAdjacentHTML('beforeend', answerHtml);
    
    // Initialize remove button for new answer
    answersContainer.lastElementChild.querySelector('.remove-answer-btn').addEventListener('click', function() {
        this.closest('.answer-item').remove();
    });
}

function submitForm() {
    const form = document.getElementById('course-form');
    const formData = new FormData(form);
    
    // Add a hidden field to indicate this is an AJAX submission
    formData.append('is_ajax', 'true');
    
    // Show loading state
    const submitBtn = document.getElementById('submit-course-btn');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> جاري الحفظ...';
    submitBtn.disabled = true;
    
    // Submit via fetch
    fetch(form.action || '{% url "update_course" course.id %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message with Bootstrap alert
            showAlert('success', data.message);
            // Redirect to course detail page after 2 seconds
            setTimeout(() => {
                if (data.redirect_url) {
                    window.location.href = data.redirect_url;
                }
            }, 2000);
        } else {
            // Show error message
            showAlert('danger', 'حدث خطأ: ' + data.message);
            // Reset button
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('danger', 'حدث خطأ في الشبكة');
        // Reset button
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
}

// Function to show Bootstrap alerts
function showAlert(type, message) {
    // Remove existing alerts
    const existingAlerts = document.querySelectorAll('.alert-custom');
    existingAlerts.forEach(alert => alert.remove());
    
    // Create new alert
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show alert-custom`;
    alertDiv.style.position = 'fixed';
    alertDiv.style.top = '20px';
    alertDiv.style.right = '20px';
    alertDiv.style.zIndex = '9999';
    alertDiv.style.minWidth = '300px';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Add to body
    document.body.appendChild(alertDiv);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// Step navigation functions
function nextStep() {
    const currentStep = document.querySelector('.step-card:not(.d-none)');
    const nextStep = currentStep.nextElementSibling;
    
    if (nextStep && nextStep.classList.contains('step-card')) {
        currentStep.classList.add('d-none');
        nextStep.classList.remove('d-none');
        
        // Update stepper
        updateStepper();
    }
}

function prevStep() {
    const currentStep = document.querySelector('.step-card:not(.d-none)');
    const prevStep = currentStep.previousElementSibling;
    
    if (prevStep && prevStep.classList.contains('step-card')) {
        currentStep.classList.add('d-none');
        prevStep.classList.remove('d-none');
        
        // Update stepper
        updateStepper();
    }
}

function updateStepper() {
    const steps = document.querySelectorAll('.step-item');
    const currentStepIndex = Array.from(document.querySelectorAll('.step-card')).findIndex(step => !step.classList.contains('d-none'));
    
    steps.forEach((step, index) => {
        if (index <= currentStepIndex) {
            step.classList.add('active');
        } else {
            step.classList.remove('active');
        }
    });
}
</script>

<!-- Module Template -->
<template id="module-template">
  <div class="card mb-4 module-card">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
      <h5 class="mb-0"><i class="fas fa-layer-group text-primary me-2"></i>موديول جديد</h5>
      <button type="button" class="btn btn-sm btn-outline-danger remove-module-btn">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="card-body">
      <div class="mb-3">
        <label class="form-label">عنوان الموديول</label>
        <input type="text" class="form-control" name="module_name" placeholder="أدخل عنوان الموديول" required>
      </div>

      <div class="mb-3">
        <label class="form-label">الفيديو</label>
        <input type="file" class="form-control" name="module_video" accept="video/*" required>
      </div>

      <div class="mb-3">
        <label class="form-label">عنوان الفيديو</label>
        <input type="text" class="form-control" name="video_title" placeholder="أدخل عنوان الفيديو" required>
      </div>

      <div class="mb-3">
        <label class="form-label">ملف PDF</label>
        <input type="file" class="form-control" name="module_pdf" accept=".pdf" required>
      </div>

      <div class="mb-3">
        <label class="form-label">ملاحظات</label>
        <textarea class="form-control" name="module_notes" rows="3" placeholder="أضف ملاحظات إضافية عن الموديول"></textarea>
      </div>

      <!-- Quiz Section -->
      <div class="card mb-3">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <h6 class="mb-0"><i class="fas fa-question-circle me-2"></i>اختبار الموديول</h6>
          <div class="form-check form-switch">
            <input class="form-check-input quiz-toggle" type="checkbox" id="has_quiz" name="has_quiz">
            <label class="form-check-label" for="has_quiz">إضافة اختبار</label>
          </div>
        </div>
        <div class="card-body quiz-section" style="display: none;">
          <div class="questions-container"></div>
          <button type="button" class="btn btn-sm btn-outline-primary mt-3 add-question-btn">
            <i class="fas fa-plus me-1"></i>إضافة سؤال
          </button>
        </div>
      </div>
    </div>
  </div>
</template>

<!-- Question Template -->
<template id="question-template">
  <div class="card mb-3 question-card">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="mb-0">سؤال جديد</h6>
        <button type="button" class="btn btn-sm btn-outline-danger remove-question-btn">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="mb-3">
        <input type="text" class="form-control" name="question_text" placeholder="نص السؤال" required>
      </div>

      <div class="mb-3">
        <select class="form-select question-type-select">
          <option value="multiple_choice">اختيار من متعدد</option>
          <option value="true_false">صح أو خطأ</option>
          <option value="short_answer">إجابة قصيرة</option>
        </select>
      </div>

      <div class="answers-container">
        <div class="answer-item mb-2">
          <div class="input-group">
            <div class="input-group-text">
              <input class="form-check-input mt-0" type="radio" name="correct_answer" value="0" checked>
            </div>
            <input type="text" class="form-control" name="answer_text" placeholder="الإجابة 1" required>
            <button type="button" class="btn btn-sm btn-outline-danger remove-answer-btn">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
      </div>

      <button type="button" class="btn btn-sm btn-outline-primary mt-2 add-answer-btn">
        <i class="fas fa-plus me-1"></i>إضافة إجابة
      </button>
    </div>
  </div>
</template>

{% endblock dashboard_content %}
