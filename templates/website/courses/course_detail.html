{% extends 'main/base.html' %}
{% load static %}

{% block title %}{{ course.name }} - Course Details{% endblock %}

{% block head %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'css/course-detail.css' %}">
    <script src="{% static 'js/course-detail.js' %}" defer></script>
{% endblock %}

{% block content %}

    <div class="container" dir="rtl">

        <!-- Main Course Content -->
        <div class="course-main">
            <div class="course-content">
                <!-- Course Hero -->
                <section class="course-hero">
                    <h1 class="course-title">{{ course.name }}</h1>
                    <p class="course-subtitle">{{ course.small_description }}</p>
                    
                    <div class="course-meta">
                        <div class="meta-item rating">
                            <div class="stars">
                                {% with ''|center:course.rating as range %}
                                    {% for _ in range %}
                                        <i class="fas fa-star"></i>
                                    {% endfor %}
                                    {% if course.rating|floatformat:0 != course.rating %}
                                        <i class="fas fa-star-half-alt"></i>
                                    {% endif %}
                                {% endwith %}
                            </div>
                            <span>{{ course.rating|floatformat:1 }} ({{ course.reviews.count }} تقييم)</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-users"></i>
                            <span>{{ course.enroller_user.count }} طالب</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-layer-group"></i>
                            <span>{{ course.modules }} وحدات</span>
                        </div>
                    </div>

                    <div class="instructor">
                        {% if course.teacher.profile.image %}
                            <img src="{{ course.teacher.profile.image.url }}" alt="{{ course.teacher.profile.name }}" class="instructor-avatar">
                        {% else %}
                            <div class="instructor-avatar">{{ course.teacher.profile.name|slice:':1'|upper }}</div>
                        {% endif %}
                        <div class="instructor-info">
                            <h3>{{ course.teacher.profile.name }}</h3>
                            <p>{{ course.teacher.profile.bio|default:'مدرب محترف' }}</p>
                        </div>
                    </div>

                    {% if course.image_course %}
                        <img src="{{ course.image_course.url }}" alt="{{ course.name }}" class="course-image">
                    {% else %}
                        <div class="course-image-placeholder">
                            <i class="fas fa-image"></i>
                            <span>صورة الدورة التدريبية</span>
                        </div>
                    {% endif %}
                </section>

                <!-- Course Tabs -->
                <div class="course-tabs">
                    <div class="tab active" data-tab="about">عن الدورة</div>
                    <div class="tab" data-tab="content">المحتوى</div>
                    <div class="tab" data-tab="reviews">التقييمات</div>
                    <div class="tab" data-tab="faq">الأسئلة الشائعة</div>
                </div>

                <!-- Tab Content -->
                <div class="tab-content" id="about-tab" style="display: block;">
                    <!-- What You'll Learn -->
                    <section>
                        <h2 class="section-title">ما الذي ستتعلمه في هذه الدورة</h2>
                        <div class="learn-list">
                            {% if course.learned %}
                                {{ course.learned|safe }}
                            {% else %}
                                <div class="alert alert-info">
                                    لم يتم إضافة أهداف تعليمية بعد.
                                </div>
                            {% endif %}
                        </div>
                    </section>
                    
                    <!-- Course Materials -->
                    <section>
                        <h2 class="section-title">مواد الدورة</h2>
                        <div class="course-materials">
                            <div class="row">
                                {% if course.syllabus_pdf or course.materials_pdf %}
                                    <div class="col-12 mb-3">
                                        <div class="alert alert-info">
                                            يمكنك الوصول إلى مواد الدورة التفصيلية من خلال تبويب "المحتوى".
                                        </div>
                                    </div>
                                {% else %}
                                    <div class="col-12">
                                        <div class="alert alert-info">
                                            لم يتم إضافة مواد تعليمية بعد.
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </section>
                </div>
                
                <div class="tab-content" id="content-tab" style="display: none;">
                    <!-- Course Content Tab -->
                    <section>
                        <h2 class="section-title">محتوى الدورة</h2>
                        
                        <!-- Content Sub-Tabs -->
                        <div class="content-subtabs">
                            <div class="subtab active" data-subtab="modules">الوحدات</div>
                            {% if course.syllabus_pdf %}
                            <div class="subtab" data-subtab="syllabus">منهج الدورة</div>
                            {% endif %}
                            {% if course.materials_pdf %}
                            <div class="subtab" data-subtab="materials">مواد إضافية</div>
                            {% endif %}
                        </div>
                        
                        <!-- Modules Sub-Tab Content -->
                        <div class="subtab-content" id="modules-subtab" style="display: block;">
                            <div class="course-modules">
                                {% for module in modules %}
                                    <div class="module-item">
                                        <div class="module-header">
                                            <h3>الوحدة {{ forloop.counter }}: {{ module.name }}</h3>
                                            <span class="module-meta">
                                                {% with content_count=module.get_ordered_content|length %}
                                                    {{ content_count }} عنصر
                                                {% endwith %}
                                                {% if module.video_duration %}
                                                    • {{ module.video_duration|floatformat:0 }} دقيقة
                                                {% endif %}
                                            </span>
                                        </div>
                                        <div class="module-content">
                                            {% for item in module.get_ordered_content %}
                                                {% if item.type == 'video' %}
                                                    <div class="content-item video-item">
                                                        {% if is_enrolled %}
                                                            <a href="{% url 'courseviewpage' course_id=course.id %}?content_type=video&content_id={{ item.id }}" class="content-link">
                                                        {% else %}
                                                            <div class="content-link locked">
                                                        {% endif %}
                                                            <div class="content-header">
                                                                <i class="fas fa-play-circle"></i>
                                                                <span class="content-title">{{ item.name }}</span>
                                                                <span class="content-meta">
                                                                    {% if item.duration %}
                                                                        {{ item.duration|floatformat:0 }} دقيقة
                                                                    {% else %}
                                                                        --:--
                                                                    {% endif %}
                                                                </span>
                                                                {% if not is_enrolled %}
                                                                    <i class="fas fa-lock text-muted"></i>
                                                                {% endif %}
                                                            </div>
                                                        {% if is_enrolled %}
                                                            </a>
                                                        {% else %}
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                {% elif item.type == 'pdf' %}
                                                    <div class="content-item pdf-item">
                                                        {% if is_enrolled %}
                                                            <a href="{% url 'courseviewpage' course_id=course.id %}?content_type=pdf&content_id={{ item.id }}" class="content-link">
                                                        {% else %}
                                                            <div class="content-link locked">
                                                        {% endif %}
                                                            <div class="content-header">
                                                                <i class="fas fa-file-pdf"></i>
                                                                <span class="content-title">{{ item.name }}</span>
                                                                <span class="content-meta">PDF</span>
                                                                {% if not is_enrolled %}
                                                                    <i class="fas fa-lock text-muted"></i>
                                                                {% endif %}
                                                            </div>
                                                        {% if is_enrolled %}
                                                            </a>
                                                        {% else %}
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                {% elif item.type == 'note' %}
                                                    <div class="content-item note-item">
                                                        {% if is_enrolled %}
                                                            <a href="{% url 'courseviewpage' course_id=course.id %}?content_type=note&content_id={{ item.id }}" class="content-link">
                                                        {% else %}
                                                            <div class="content-link locked">
                                                        {% endif %}
                                                            <div class="content-header">
                                                                <i class="fas fa-sticky-note"></i>
                                                                <span class="content-title">{{ item.name }}</span>
                                                                <span class="content-meta">ملاحظات</span>
                                                                {% if not is_enrolled %}
                                                                    <i class="fas fa-lock text-muted"></i>
                                                                {% endif %}
                                                            </div>
                                                        {% if is_enrolled %}
                                                            </a>
                                                        {% else %}
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                {% elif item.type == 'quiz' %}
                                                    <div class="content-item quiz-item">
                                                        {% if is_enrolled %}
                                                            <a href="{% url 'courseviewpage' course_id=course.id %}?content_type=quiz&content_id={{ item.id }}" class="content-link">
                                                        {% else %}
                                                            <div class="content-link locked">
                                                        {% endif %}
                                                            <div class="content-header">
                                                                <i class="fas fa-question-circle"></i>
                                                                <span class="content-title">{{ item.name }}</span>
                                                                <span class="content-meta">
                                                                    {{ item.questions_count }} سؤال
                                                                    {% if item.time_limit %}
                                                                        • {{ item.time_limit }} دقيقة
                                                                    {% endif %}
                                                                </span>
                                                                {% if not is_enrolled %}
                                                                    <i class="fas fa-lock text-muted"></i>
                                                                {% endif %}
                                                            </div>
                                                        {% if is_enrolled %}
                                                            </a>
                                                        {% else %}
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                {% elif item.type == 'assignment' %}
                                                    <div class="content-item assignment-item">
                                                        {% if is_enrolled %}
                                                            <a href="{% url 'courseviewpage' course_id=course.id %}?content_type=assignment&content_id={{ item.id }}" class="content-link">
                                                        {% else %}
                                                            <div class="content-link locked">
                                                        {% endif %}
                                                            <div class="content-header">
                                                                <i class="fas fa-tasks"></i>
                                                                <span class="content-title">{{ item.name }}</span>
                                                                <span class="content-meta">
                                                                    {{ item.points }} نقطة
                                                                    {% if item.due_date %}
                                                                        • مطلوب: {{ item.due_date|date:"d/m/Y" }}
                                                                    {% endif %}
                                                                </span>
                                                                {% if not is_enrolled %}
                                                                    <i class="fas fa-lock text-muted"></i>
                                                                {% endif %}
                                                            </div>
                                                        {% if is_enrolled %}
                                                            </a>
                                                        {% else %}
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                {% endif %}
                                            {% empty %}
                                                <div class="no-content">لا يوجد محتوى في هذه الوحدة</div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                {% empty %}
                                    <div class="alert alert-info">لم يتم إضافة وحدات بعد</div>
                                {% endfor %}
                                
                                <!-- Final Exams Section -->
                                {% if final_exams %}
                                    <div class="module-item final-exams-section">
                                        <div class="module-header">
                                            <h3><i class="fas fa-graduation-cap text-primary"></i> الاختبارات النهائية</h3>
                                            <span class="module-meta">{{ final_exams.count }} اختبار نهائي</span>
                                        </div>
                                        <div class="module-content">
                                            {% for exam in final_exams %}
                                                <div class="content-item exam-item">
                                                    {% if is_enrolled %}
                                                        <a href="{% url 'courseviewpage' course_id=course.id %}?content_type=exam&content_id={{ exam.id }}" class="content-link">
                                                    {% else %}
                                                        <div class="content-link locked">
                                                    {% endif %}
                                                        <div class="content-header">
                                                            <i class="fas fa-graduation-cap"></i>
                                                            <span class="content-title">{{ exam.title }}</span>
                                                            <span class="content-meta">
                                                                {{ exam.questions.count }} سؤال
                                                                {% if exam.time_limit %}
                                                                    • {{ exam.time_limit }} دقيقة
                                                                {% endif %}
                                                                • نسبة النجاح: {{ exam.pass_mark }}%
                                                            </span>
                                                            {% if not is_enrolled %}
                                                                <i class="fas fa-lock text-muted"></i>
                                                            {% endif %}
                                                        </div>
                                                    {% if is_enrolled %}
                                                        </a>
                                                    {% else %}
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                {% endif %}
                                
                                <!-- Course-level Assignments -->
                                {% if course_assignments %}
                                    <div class="module-item course-assignments-section">
                                        <div class="module-header">
                                            <h3><i class="fas fa-clipboard-list text-success"></i> واجبات الدورة</h3>
                                            <span class="module-meta">{{ course_assignments.count }} واجب</span>
                                        </div>
                                        <div class="module-content">
                                            {% for assignment in course_assignments %}
                                                <div class="content-item assignment-item">
                                                    {% if is_enrolled %}
                                                        <a href="{% url 'courseviewpage' course_id=course.id %}?content_type=assignment&content_id={{ assignment.id }}" class="content-link">
                                                    {% else %}
                                                        <div class="content-link locked">
                                                    {% endif %}
                                                        <div class="content-header">
                                                            <i class="fas fa-clipboard-list"></i>
                                                            <span class="content-title">{{ assignment.title }}</span>
                                                            <span class="content-meta">
                                                                {{ assignment.points }} نقطة
                                                                {% if assignment.due_date %}
                                                                    • مطلوب: {{ assignment.due_date|date:"d/m/Y" }}
                                                                {% endif %}
                                                            </span>
                                                            {% if not is_enrolled %}
                                                                <i class="fas fa-lock text-muted"></i>
                                                            {% endif %}
                                                        </div>
                                                    {% if is_enrolled %}
                                                        </a>
                                                    {% else %}
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Syllabus PDF Sub-Tab Content -->
                        {% if course.syllabus_pdf %}
                        <div class="subtab-content" id="syllabus-subtab" style="display: none;">
                            <div class="pdf-viewer">
                                <h3>منهج الدورة التفصيلي</h3>
                                <div class="pdf-container">
                                    <!-- محاولة عرض PDF بطرق متعددة للتوافق -->
                                    <iframe src="{{ course.syllabus_pdf.url }}" 
                                            width="100%" 
                                            height="600px" 
                                            style="border: 1px solid #ddd; border-radius: 8px;"
                                            title="منهج الدورة التفصيلي">
                                    </iframe>
                                    
                                    <!-- Fallback للمتصفحات التي لا تدعم iframe -->
                                    <noscript>
                                        <object data="{{ course.syllabus_pdf.url }}" 
                                                type="application/pdf" 
                                                width="100%" 
                                                height="600px"
                                                style="border: 1px solid #ddd; border-radius: 8px;">
                                            <embed src="{{ course.syllabus_pdf.url }}" 
                                                   type="application/pdf" 
                                                   width="100%" 
                                                   height="600px"
                                                   style="border: 1px solid #ddd; border-radius: 8px;">
                                        </object>
                                    </noscript>
                                </div>
                                
                                <!-- أزرار التحكم والتحميل -->
                                <div class="pdf-controls" style="text-align: center; margin-top: 15px; padding: 15px; background-color: #f8f9fa; border-radius: 8px;">
                                    <div class="btn-group" role="group">
                                        <a href="{{ course.syllabus_pdf.url }}" 
                                           target="_blank" 
                                           class="btn btn-primary btn-sm">
                                            <i class="fas fa-external-link-alt"></i> فتح في نافذة جديدة
                                        </a>
                                        <a href="{{ course.syllabus_pdf.url }}" 
                                           download 
                                           class="btn btn-success btn-sm">
                                            <i class="fas fa-download"></i> تحميل الملف
                                        </a>
                                     
                                    </div>
                                    <p class="text-muted mt-2 mb-0">
                                        <small>إذا لم يظهر الملف بشكل صحيح، استخدم الأزرار أعلاه للوصول إليه</small>
                                    </p>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Materials PDF Sub-Tab Content -->
                        {% if course.materials_pdf %}
                        <div class="subtab-content" id="materials-subtab" style="display: none;">
                            <div class="pdf-viewer">
                                <h3>مواد إضافية للدورة</h3>
                                <div class="pdf-container">
                                    <!-- محاولة عرض PDF بطرق متعددة للتوافق -->
                                    <iframe src="{{ course.materials_pdf.url }}" 
                                            width="100%" 
                                            height="600px" 
                                            style="border: 1px solid #ddd; border-radius: 8px;"
                                            title="مواد إضافية للدورة">
                                    </iframe>
                                    
                                    <!-- Fallback للمتصفحات التي لا تدعم iframe -->
                                    <noscript>
                                        <object data="{{ course.materials_pdf.url }}" 
                                                type="application/pdf" 
                                                width="100%" 
                                                height="600px"
                                                style="border: 1px solid #ddd; border-radius: 8px;">
                                            <embed src="{{ course.materials_pdf.url }}" 
                                                   type="application/pdf" 
                                                   width="100%" 
                                                   height="600px"
                                                   style="border: 1px solid #ddd; border-radius: 8px;">
                                        </object>
                                    </noscript>
                                </div>
                                
                                <!-- أزرار التحكم والتحميل -->
                                <div class="pdf-controls" style="text-align: center; margin-top: 15px; padding: 15px; background-color: #f8f9fa; border-radius: 8px;">
                                    <div class="btn-group" role="group">
                                        <a href="{{ course.materials_pdf.url }}" 
                                           target="_blank" 
                                           class="btn btn-primary btn-sm">
                                            <i class="fas fa-external-link-alt"></i> فتح في نافذة جديدة
                                        </a>
                                        <a href="{{ course.materials_pdf.url }}" 
                                           download 
                                           class="btn btn-success btn-sm">
                                            <i class="fas fa-download"></i> تحميل الملف
                                        </a>
                               
                                    </div>
                                    <p class="text-muted mt-2 mb-0">
                                        <small>إذا لم يظهر الملف بشكل صحيح، استخدم الأزرار أعلاه للوصول إليه</small>
                                    </p>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </section>
                </div>
                
                <!-- The content tab section has been moved above -->
                
                <div class="tab-content" id="reviews-tab" style="display: none;">
                    <!-- Reviews Tab -->
                    <section>
                        <h2 class="section-title">تقييمات الطلاب</h2>
                        
                        <!-- Review Statistics -->
                        <div class="review-stats">
                            <div class="rating-summary">
                                <div class="average-rating">{{ course.rating|floatformat:1 }}</div>
                                <div class="stars">
                                    {% for i in "12345"|make_list %}
                                        {% if forloop.counter <= course.rating|floatformat:0|add:"0" %}
                                            <i class="fas fa-star"></i>
                                        {% elif forloop.counter <= course.rating|floatformat:1|add:"0.5" %}
                                            <i class="fas fa-star-half-alt"></i>
                                        {% else %}
                                            <i class="far fa-star"></i>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                                <div class="total-reviews">{{ reviews.count }} تقييم</div>
                            </div>
                        </div>
                        
                        <!-- Add Review Form -->
                        {% if user.is_authenticated and is_enrolled %}
                            <div class="add-review-section">
                                <h3>أضف تقييمك</h3>
                                <form method="POST" action="{% url 'course_detail' course_id=course.id %}" class="review-form">
                                    {% csrf_token %}
                                    <div class="rating-input">
                                        <label>تقييمك:</label>
                                        <div class="star-rating">
                                            {% for i in "12345"|make_list %}
                                                <input type="radio" id="star{{ i }}" name="review_rating" value="{{ i }}" {% if user_review and user_review.rating == forloop.counter %}checked{% endif %} required>
                                                <label for="star{{ i }}"><i class="fas fa-star"></i></label>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="review_comment">تعليقك:</label>
                                        <textarea id="review_comment" name="review_comment" rows="4" class="form-control">{{ user_review.comment|default:'' }}</textarea>
                                    </div>
                                    <button type="submit" class="btn btn-primary">{{ user_review|yesno:"تحديث التقييم,إضافة تقييم" }}</button>
                                </form>
                            </div>
                        {% elif user.is_authenticated and not is_enrolled %}
                            <div class="alert alert-info">يجب أن تكون مسجلاً في الدورة لإضافة تقييم</div>
                        {% elif not user.is_authenticated %}
                            <div class="alert alert-info">يجب تسجيل الدخول لإضافة تقييم</div>
                        {% endif %}
                        
                        <!-- Reviews List -->
                        <div class="reviews-list">
                            {% for review in reviews %}
                                <div class="review-item">
                                    <div class="review-header">
                                        <div class="reviewer-info">
                                            {% if review.user.profile.image %}
                                                <img src="{{ review.user.profile.image.url }}" alt="{{ review.user.username }}" class="reviewer-avatar">
                                            {% else %}
                                                <div class="reviewer-avatar">{{ review.user.username|slice:":1"|upper }}</div>
                                            {% endif %}
                                            <div>
                                                <div class="reviewer-name">{{ review.user.username }}</div>
                                                <div class="review-date">{{ review.created_at|date:"d/m/Y" }}</div>
                                            </div>
                                        </div>
                                        <div class="review-rating">
                                            {% for i in "12345"|make_list %}
                                                {% if forloop.counter <= review.rating %}
                                                    <i class="fas fa-star"></i>
                                                {% else %}
                                                    <i class="far fa-star"></i>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <div class="review-content">
                                        {{ review.comment|linebreaks|default:"" }}
                                    </div>
                                </div>
                            {% empty %}
                                <div class="no-reviews">لا توجد تقييمات بعد. كن أول من يقيم هذه الدورة!</div>
                            {% endfor %}
                        </div>
                    </section>
                </div>
                
                <div class="tab-content" id="faq-tab" style="display: none;">
                    <!-- FAQ Tab -->
                    <section>
                        <h2 class="section-title">الأسئلة الشائعة</h2>
                        <div class="faq-list">
                            <div class="faq-item">
                                <div class="faq-question">هل يمكنني الوصول إلى المحتوى بعد انتهاء الدورة؟</div>
                                <div class="faq-answer">نعم، بمجرد التسجيل في الدورة، يمكنك الوصول إلى جميع المحتويات مدى الحياة.</div>
                            </div>
                            <div class="faq-item">
                                <div class="faq-question">هل هناك شهادة عند إكمال الدورة؟</div>
                                <div class="faq-answer">نعم، ستحصل على شهادة إتمام بعد إكمال جميع وحدات الدورة.</div>
                            </div>
                            <div class="faq-item">
                                <div class="faq-question">هل يمكنني تنزيل الفيديوهات؟</div>
                                <div class="faq-answer">لا، الفيديوهات متاحة للمشاهدة عبر الإنترنت فقط.</div>
                            </div>
                        </div>
                    </section>
                </div>

                <!-- Requirements -->
                <section>
                    <h2 class="section-title">المتطلبات</h2>
                    <div class="requirements-list">
                        {% if course.requirements %}
                            {{ course.requirements|safe }}
                        {% else %}
                            <div class="alert alert-info">
                                لا توجد متطلبات مسبقة لهذه الدورة.
                            </div>
                        {% endif %}
                    </div>
                </section>

                <!-- Description -->
                <section>
                    <h2 class="section-title">وصف الدورة</h2>
                    <div class="course-description">
                        {% if course.description %}
                            {{ course.description|safe }}
                        {% else %}
                            <p>لا يوجد وصف متوفر لهذه الدورة.</p>
                        {% endif %}
                    </div>
                </section>

                <!-- Instructor Section -->
                <section class="instructor-section">
                    <h2 class="section-title">عن المدرب</h2>
                    <div class="instructor">
                        {% if course.teacher.profile.image %}
                            <img src="{{ course.teacher.profile.image.url }}" alt="{{ course.teacher.profile.name }}" class="instructor-avatar">
                        {% else %}
                            <div class="instructor-avatar">{{ course.teacher.profile.name|slice:':1'|upper }}</div>
                        {% endif %}
                        <div class="instructor-info">
                            <h3>{{ course.teacher.profile.name }}</h3>
                            <p class="instructor-title">{{ course.teacher.profile.title|default:'مدرب محترف' }}</p>
                            {% if course.teacher.profile.bio %}
                                <p class="instructor-bio">{{ course.teacher.profile.bio }}</p>
                            {% endif %}
                            <div class="instructor-meta">
                                {% if course.teacher.profile.phone %}
                                    <span><i class="fas fa-phone"></i> {{ course.teacher.profile.phone }}</span>
                                {% endif %}
                                {% if course.teacher.email %}
                                    <span><i class="fas fa-envelope"></i> {{ course.teacher.email }}</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="instructor-bio">
                        <p>{{ course.teacher.profile.bio }}</p>
                    </div>
                </section>

                <!-- Reviews Section -->
                <section class="reviews-section">
                    <h2 class="section-title">تقييمات الطلاب</h2>
                    <div class="reviews-header">
                        <div class="average-rating">
                            <div class="rating-number">4.7</div>
                            <div class="rating-stars">
                                <div class="stars">
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star-half-alt"></i>
                                </div>
                                <div class="rating-count">1,245 تقييم</div>
                            </div>
                        </div>
                       
                    </div>

                    <div class="review">
                        <div class="review-header">
                            <div class="reviewer">
                                <div class="reviewer-avatar">{{ course.teacher.profile.name|slice:':1'|upper }}</div>
                                <div class="reviewer-info">
                                    <h4>{{ course.teacher.profile.name }}</h4>
                                    <div class="review-date">{{ course.created_at|date:"M d, Y" }}</div>
                                </div>
                            </div>
                            <div class="stars">
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="far fa-star"></i>
                            </div>
                        </div>
                        <div class="review-content">
                            <p>الدورة جيدة جداً للمبتدئين، ولكن أتمنى أن تكون هناك أجزاء أكثر تقدماً. بشكل عام الشرح واضح والمواد التعليمية منظمة جيداً.</p>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Sidebar -->
            <div class="course-sidebar">
                <div class="sidebar-card">
                    <div class="price-container">
                        <span class="original-price">${{ course.price }}</span>
                        <span class="current-price">${{ course.discount_price }}</span>
                        <span class="discount-badge">خصم {{ course.discount }}%</span>
                    </div>
                    {% if user.is_authenticated and is_enrolled %}
                        <a href="{% url 'courseviewpage' course_id=course.id %}" class="btn btn-success sidebar-btn">عرض الدورة</a>
                    {% elif user.is_authenticated %}
                        {% if in_cart %}
                            <a href="{% url 'add_to_cart' course_id=course.id %}?next=view_course" class="btn btn-success sidebar-btn">عرض الدورة</a>
                            <a href="{% url 'view_cart' %}" class="btn btn-info sidebar-btn mt-2">عرض السلة</a>
                        {% else %}
                            <form method="post" action="{% url 'add_to_cart' course_id=course.id %}" class="mb-2">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-primary sidebar-btn add-to-cart-btn">إضافة إلى السلة</button>
                            </form>
                            <a href="{% url 'enroll_course' course_id=course.id %}" class="btn btn-outline-primary sidebar-btn">اشترك الآن</a>
                            <div class="mt-2 text-center">
                                <small class="text-muted">يمكنك الاشتراك مباشرة أو إضافة الدورة للسلة</small>
                            </div>
                        {% endif %}
                    {% else %}
                        <a href="{% url 'login' %}?next={% url 'course_detail' course_id=course.id %}" class="btn btn-primary sidebar-btn">تسجيل الدخول للاشتراك</a>
                        <div class="mt-2 text-center">
                            <small class="text-muted">يجب تسجيل الدخول أولاً</small>
                        </div>
                    {% endif %}
                    <button class="btn btn-outline sidebar-btn" style="border-color: var(--dark-color); color: var(--dark-color);">أضف إلى المفضلة</button>
                    <p class="money-back">ضمان استرداد الأموال لمدة 30 يومًا</p>
                    
                    <h3>تشمل هذه الدورة:</h3>
                    <div class="includes-list">
                        <div class="includes-item">
                            <i class="fas fa-video"></i>
                            <span>{{ course.videos }} محاضرة</span>
                        </div>
                        <div class="includes-item">
                            <i class="fas fa-file-alt"></i>
                            <span>{{ course.notes }} مقالة</span>
                        </div>
                        <div class="includes-item">
                            <i class="fas fa-download"></i>
                            <span>{{ course.resources }} موارد قابلة للتنزيل</span>
                        </div>
                        <div class="includes-item">
                            <i class="fas fa-infinity"></i>
                            <span>وصول كامل مدى الحياة</span>
                        </div>
                        <div class="includes-item">
                            <i class="fas fa-mobile-alt"></i>
                            <span>الوصول عبر الهاتف والتلفزيون</span>
                        </div>
                        <div class="includes-item">
                            <i class="fas fa-trophy"></i>
                            <span>شهادة إتمام</span>
                        </div>
                    </div>

                    <div class="share-options">
                        <div class="share-btn">
                            <i class="fab fa-facebook-f"></i>
                        </div>
                        <div class="share-btn">
                            <i class="fab fa-twitter"></i>
                        </div>
                        <div class="share-btn">
                            <i class="fab fa-linkedin-in"></i>
                        </div>
                        <div class="share-btn">
                            <i class="fas fa-envelope"></i>
                        </div>
                    </div>
                </div>

                <div class="sidebar-card">
                    <h3>تدريب الشركات</h3>
                    <p>احصل على فريقك مدربًا على أكبر مجموعة من الموضوعات.</p>
                    <button class="btn btn-primary sidebar-btn">تواصل معنا</button>
                </div>
            </div>
        </div>

        <!-- Related Courses -->
        <section class="instructor-courses">
            <h2 class="section-title">دورات أخرى للمدرب</h2>
            <div class="courses-grid">
                {% for instructor_course in course.teacher.course_set.all|slice:":3" %}
                    {% if instructor_course.id != course.id %}
                        <div class="course-card">
                            <div class="course-card-img">
                                <img src="{{ instructor_course.image_course.url }}" alt="{{ instructor_course.name }}">
                            </div>
                            <div class="course-card-body">
                                <h3 class="course-card-title">{{ instructor_course.name }}</h3>
                                <p class="course-card-instructor">{{ instructor_course.teacher.profile.name }}</p>
                                <div class="course-card-meta">
                                    <div class="course-card-rating">
                                        <span>{{ instructor_course.rating }}</span>
                                        <i class="fas fa-star"></i>
                                    </div>
                                    <span>({{ instructor_course.reviews.count }})</span>
                                </div>
                                <div class="course-card-price">
                                    <span class="current-price">${{ instructor_course.discount_price|default:instructor_course.price }}</span>
                                    {% if instructor_course.discount_price %}
                                        <span class="original-price">${{ instructor_course.price }}</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endif %}
                {% empty %}
                    <p class="no-courses">لا توجد دورات أخرى لهذا المدرب حالياً</p>
                {% endfor %}
            </div>
        </section>
    </div>

{% endblock %}

