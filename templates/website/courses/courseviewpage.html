{% extends 'main/base.html' %}

{% load static %}
{% load course_filters %}

{% block title %}{{ course.name }} - Ø¯ÙˆØ±Ø© ØªØ¯Ø±ÙŠØ¨ÙŠØ©{% endblock %}

{% block head %}
    {{ block.super }}
   <link rel="stylesheet" href="{% static 'css/course-view.css' %}">
   <link rel="stylesheet" href="{% static 'css/course-content-enhanced.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <meta name="course-id" content="{{ course.id }}">
    <script src="{% static 'js/course-view.js' %}"></script>
    <script src="{% static 'js/course-modules.js' %}"></script>
    <script src="{% static 'js/attendance_tracking.js' %}"></script>
    <script src="{% static 'js/pdf-handler.js' %}"></script>
    <script src="{% static 'js/course-enhanced.js' %}"></script>
    <script src="{% static 'js/enhanced-progress-system.js' %}"></script>

    <!-- Enhanced Progress Calculation Script -->
    <script>
        // Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¯ÙŠÙˆÙ„Ø§Øª ÙˆØ¹Ù†Ø§ØµØ±Ù‡Ø§ Ø§Ù„Ø®Ù…Ø³Ø©
        function calculateModuleBasedProgress() {
            const modules = document.querySelectorAll('.module-item');
            if (modules.length === 0) return 0;
            
            const progressPerModule = 100 / modules.length;  // Ù†Ø³Ø¨Ø© ÙƒÙ„ Ù…ÙˆØ¯ÙŠÙˆÙ„
            const elementsPerModule = 5;  // 5 Ø¹Ù†Ø§ØµØ± Ù„ÙƒÙ„ Ù…ÙˆØ¯ÙŠÙˆÙ„ (ÙÙŠØ¯ÙŠÙˆØŒ PDFØŒ Ù…Ù„Ø§Ø­Ø¸Ø§ØªØŒ ÙˆØ§Ø¬Ø¨ØŒ Ø§Ø®ØªØ¨Ø§Ø±)
            const progressPerElement = progressPerModule / elementsPerModule;  // 10% Ù„ÙƒÙ„ Ø¹Ù†ØµØ± ÙÙŠ Ø­Ø§Ù„Ø© ÙˆØ¬ÙˆØ¯ Ù…ÙˆØ¯ÙŠÙˆÙ„ÙŠÙ†
            
            let totalProgress = 0;
            
            modules.forEach((module, moduleIndex) => {
                const moduleProgress = calculateSingleModuleProgress(module, progressPerElement);
                totalProgress += moduleProgress;
                
                // Ø¹Ø±Ø¶ ØªÙ‚Ø¯Ù… Ø§Ù„Ù…ÙˆØ¯ÙŠÙˆÙ„ ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                updateModuleProgressDisplay(module, moduleProgress, progressPerModule);
            });
            
            return Math.min(totalProgress, 100);
        }
        
        function calculateSingleModuleProgress(moduleElement, progressPerElement) {
            const moduleContent = moduleElement.querySelector('.module-content');
            if (!moduleContent) return 0;
            
            let moduleProgress = 0;
            
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø®Ù…Ø³Ø© ÙÙŠ Ø§Ù„Ù…ÙˆØ¯ÙŠÙˆÙ„
            const elements = {
                video: moduleContent.querySelector('.content-item[data-content-type="video"], .content-item[data-content-type="module_video"]'),
                pdf: moduleContent.querySelector('.content-item[data-content-type="pdf"], .content-item[data-content-type="module_pdf"]'),
                note: moduleContent.querySelector('.content-item[data-content-type="note"], .content-item[data-content-type="module_note"]'),
                assignment: moduleContent.querySelector('.content-item[data-content-type="assignment"]'),
                quiz: moduleContent.querySelector('.content-item[data-content-type="quiz"]')
            };
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙ‚Ø¯Ù… Ù„ÙƒÙ„ Ø¹Ù†ØµØ±
            Object.keys(elements).forEach(elementType => {
                const element = elements[elementType];
                if (element) {
                    if (element.classList.contains('completed')) {
                        moduleProgress += progressPerElement;
                    }
                }
            });
            
            return moduleProgress;
        }
        
        function updateModuleProgressDisplay(moduleElement, currentProgress, maxProgress) {
            const moduleHeader = moduleElement.querySelector('.module-header');
            if (!moduleHeader) return;
            
            // Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… Ù„Ù„Ù…ÙˆØ¯ÙŠÙˆÙ„
            let progressIndicator = moduleHeader.querySelector('.module-progress-indicator');
            if (!progressIndicator) {
                progressIndicator = document.createElement('div');
                progressIndicator.className = 'module-progress-indicator';
                progressIndicator.innerHTML = `
                    <div class="module-progress-bar">
                        <div class="module-progress-fill"></div>
                    </div>
                    <span class="module-progress-text">0%</span>
                `;
                moduleHeader.appendChild(progressIndicator);
            }
            
            const progressFill = progressIndicator.querySelector('.module-progress-fill');
            const progressText = progressIndicator.querySelector('.module-progress-text');
            
            const percentage = (currentProgress / maxProgress) * 100;
            
            if (progressFill) {
                progressFill.style.width = percentage + '%';
                progressFill.style.backgroundColor = percentage >= 100 ? '#10b981' : '#3b82f6';
            }
            
            if (progressText) {
                progressText.textContent = Math.round(percentage) + '%';
            }
        }
        
        function updateOverallProgress() {
            const newProgress = calculateModuleBasedProgress();
            
            // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
            const progressBar = document.querySelector('.progress-fill-sidebar');
            const progressText = document.querySelector('.progress-title-sidebar');
            
            if (progressBar) {
                progressBar.style.width = newProgress + '%';
                progressBar.setAttribute('data-progress', newProgress);
            }
            
            if (progressText) {
                progressText.innerHTML = progressText.innerHTML.replace(/ØªÙ‚Ø¯Ù…Ùƒ: \d+\.?\d*%/, `ØªÙ‚Ø¯Ù…Ùƒ: ${newProgress.toFixed(1)}%`);
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¥ÙƒÙ…Ø§Ù„
            updateCompletionStats();
            
            // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…
            sendProgressToServer(newProgress);
            
            return newProgress;
        }
        
        function updateCompletionStats() {
            const totalElements = document.querySelectorAll('.content-item').length;
            const completedElements = document.querySelectorAll('.content-item.completed').length;
            const totalModules = document.querySelectorAll('.module-item').length;
            
            const completedStat = document.querySelector('.completion-stats .stat-card:nth-child(1) .stat-number');
            const totalStat = document.querySelector('.completion-stats .stat-card:nth-child(2) .stat-number');
            const modulesStat = document.querySelector('.completion-stats .stat-card:nth-child(3) .stat-number');
            
            if (completedStat) completedStat.textContent = completedElements;
            if (totalStat) totalStat.textContent = totalElements;
            if (modulesStat) modulesStat.textContent = totalModules;
        }
        
        function sendProgressToServer(progress) {
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            const courseId = document.querySelector('meta[name="course-id"]').getAttribute('content');
            
            fetch(`/course/${courseId}/update-progress/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    progress: progress
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­:', progress.toFixed(1) + '%');
                } else {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚Ø¯Ù…:', data.message);
                }
            })
            .catch(error => {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„:', error);
            });
        }
        
        // Ø­Ø³Ø§Ø¨ Ù†Ø³Ø¨ Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„ØµØ­ÙŠØ­Ø©
        function calculateAndDisplayPercentages() {
            const modules = document.querySelectorAll('.module-item');
            const moduleCount = modules.length || 1;
            
            const modulePercentage = (100 / moduleCount).toFixed(1);
            const elementPercentage = (100 / moduleCount / 5).toFixed(1);
            
            const moduleSpan = document.getElementById('module-percentage');
            const elementSpan = document.getElementById('element-percentage');
            
            if (moduleSpan) {
                moduleSpan.textContent = modulePercentage;
            }
            
            if (elementSpan) {
                elementSpan.textContent = elementPercentage;
            }
            
            console.log(`ğŸ“Š Calculated percentages: Module=${modulePercentage}%, Element=${elementPercentage}%`);
        }

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        document.addEventListener('DOMContentLoaded', function() {
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ø³Ø¨ Ø§Ù„ØµØ­ÙŠØ­Ø©
            calculateAndDisplayPercentages();
            
            // Ø¥Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø³Ù†
            setTimeout(() => {
                if (window.enhancedProgressSystem) {
                    console.log('âœ… Using Enhanced Progress System');
                } else {
                    console.log('âš ï¸ Enhanced Progress System not loaded, using fallback');
                    updateOverallProgress();
                }
            }, 2000);
            
            // Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØºÙŠÙŠØ±Ø§Øª Ø­Ø§Ù„Ø© Ø§Ù„Ø¥ÙƒÙ…Ø§Ù„ (Ù†Ø¸Ø§Ù… Ø§Ø­ØªÙŠØ§Ø·ÙŠ)
            const observer = new MutationObserver(function(mutations) {
                let shouldUpdate = false;
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                        const target = mutation.target;
                        if (target.classList.contains('content-item')) {
                            shouldUpdate = true;
                        }
                    }
                });
                
                if (shouldUpdate) {
                    if (window.enhancedProgressSystem) {
                        setTimeout(() => window.enhancedProgressSystem.calculateOverallProgress(), 500);
                    } else {
                        setTimeout(updateOverallProgress, 500);
                    }
                }
            });
            
            // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¬Ù…ÙŠØ¹ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø­ØªÙˆÙ‰
            document.querySelectorAll('.content-item').forEach(function(item) {
                observer.observe(item, { attributes: true, attributeFilter: ['class'] });
            });
            
            // ØªØ­Ø¯ÙŠØ« Ø¯ÙˆØ±ÙŠ ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
            setInterval(() => {
                if (window.enhancedProgressSystem) {
                    window.enhancedProgressSystem.calculateOverallProgress();
                } else {
                    updateOverallProgress();
                }
            }, 30000);
        });
    </script>
    
    <!-- Enhanced Progress Styles -->
    <style>
        .module-progress-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-left: 1rem;
        }
        
        .module-progress-bar {
            width: 60px;
            height: 6px;
            background-color: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .module-progress-fill {
            height: 100%;
            background-color: #3b82f6;
            transition: width 0.8s ease-in-out;
            border-radius: 3px;
        }
        
        .module-progress-text {
            font-size: 0.75rem;
            font-weight: 600;
            color: #64748b;
            min-width: 30px;
        }
        
        .module-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        
        .enhanced-progress-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
        }
        
        .progress-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .progress-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 0.75rem;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .progress-item i {
            width: 20px;
            text-align: center;
        }
        
        .element-completed {
            color: #10b981 !important;
        }
        
        .element-pending {
            color: #f59e0b !important;
        }
        
        /* Ø§Ø³ØªØ§ÙŠÙ„ Ù„Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© */
        .content-item.completed {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%) !important;
            border-left: 4px solid #28a745 !important;
            position: relative;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.2) !important;
        }
        
        .content-item.completed .content-icon {
            background: #28a745 !important;
            color: white !important;
        }
        
        .content-item.completed .content-name {
            font-weight: 600;
            color: #1e7e34 !important;
        }
        
        .completion-badge {
            position: absolute !important;
            right: 15px !important;
            top: 50% !important;
            transform: translateY(-50%) !important;
            background: #28a745 !important;
            color: white !important;
            padding: 6px 10px !important;
            border-radius: 50% !important;
            font-size: 0.9rem !important;
            box-shadow: 0 2px 6px rgba(40, 167, 69, 0.4) !important;
            z-index: 10 !important;
            pointer-events: none !important;
        }
        
        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥ÙƒÙ…Ø§Ù„ */
        .mark-pdf-read-btn, .mark-note-read-btn {
            transition: all 0.3s ease;
            border-radius: 25px;
            padding: 8px 16px;
            font-weight: 500;
        }
        
        .mark-pdf-read-btn:hover, .mark-note-read-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .mark-pdf-read-btn.btn-success, .mark-note-read-btn.btn-success {
            background: #28a745 !important;
            border-color: #28a745 !important;
            cursor: not-allowed;
        }
        
        /* ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª */
        @keyframes slideInRight {
            from { 
                transform: translateX(100%); 
                opacity: 0; 
            }
            to { 
                transform: translateX(0); 
                opacity: 1; 
            }
        }
        
        @keyframes bounceIn {
            0% {
                transform: scale(0.3);
                opacity: 0;
            }
            50% {
                transform: scale(1.1);
                opacity: 0.8;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .completion-badge {
            animation: bounceIn 0.6s ease-out;
        }
    </style>

{% endblock %}

{% block content %}
<div class="course-container" >
    <div class="course-wrapper">
        <!-- Main Content Area -->
        <div class="course-main-content" dir="rtl">
            <!-- Content Display Section -->
            <div class="content-display-section">
                {% if current_content %}
                    <!-- Module Content -->
                    {% if current_content.type == 'module_video' %}
                        {% include 'website/courses/components/_module_video_enhanced.html' %}
                    
                    {% elif current_content.type == 'module_pdf' %}
                        {% include 'website/courses/components/_module_pdf.html' %}
                    
                    {% elif current_content.type == 'module_note' %}
                        {% include 'website/courses/components/_module_note.html' %}
                    
                    <!-- Regular Content (deprecated - using module-specific components) -->
                    
                    {% elif current_content.type == 'assignment' %}
                        {% include 'website/courses/components/_assignment.html' %}
                    
                    {% elif current_content.type == 'quiz' %}
                        {% include 'website/courses/components/_quiz.html' %}
                    
                    {% elif current_content.type == 'final_exam' %}
                        {% include 'website/courses/components/_final_exam.html' %}
                    
                    {% else %}
                        <!-- Default Content Header -->
                        <div class="content-header">
                            <h1 class="content-title">
                                {% if current_content.type == 'video' %}
                                    <i class="fas fa-play-circle text-primary me-2"></i>
                                    {{ current_content.content.name }}
                                {% elif current_content.type == 'note' %}
                                    <i class="fas fa-file-pdf text-danger me-2"></i>
                                    {{ current_content.content.description|truncatewords:8|default:"Ù…Ù„Ø§Ø­Ø¸Ø§Øª" }}
                                {% elif current_content.type == 'quiz' %}
                                    <i class="fas fa-question-circle text-warning me-2"></i>
                                    {{ current_content.content.title }}
                                {% elif current_content.type == 'assignment' %}
                                    <i class="fas fa-tasks text-success me-2"></i>
                                    {{ current_content.content.title }}
                                {% elif current_content.type == 'module_pdf' %}
                                    <i class="fas fa-file-pdf text-danger me-2"></i>
                                    Ù…Ù„Ù PDF - {{ current_content.content.name }}
                                {% elif current_content.type == 'module_video' %}
                                    <i class="fas fa-video text-primary me-2"></i>
                                    {{ current_content.content.name }}
                                {% elif current_content.type == 'module_note' %}
                                    <i class="fas fa-sticky-note text-warning me-2"></i>
                                    {{ current_content.content.title }}
                                {% elif current_content.type == 'exam' %}
                                    <i class="fas fa-graduation-cap text-primary me-2"></i>
                                    {{ current_content.content.title }}
                                {% endif %}
                            </h1>
                            
                            {% if current_content.type not in 'module_video,module_pdf,module_note' %}
                                <div class="content-meta">
                                    {% if current_content.type == 'video' %}
                                        <span class="meta-badge">
                                            <i class="far fa-clock"></i>
                                            {{ current_content.content.duration|default:'10:00' }}
                                        </span>
                                        <span class="meta-badge">
                                            <i class="fas fa-video"></i>
                                            ÙÙŠØ¯ÙŠÙˆ ØªØ¹Ù„ÙŠÙ…ÙŠ
                                        </span>
                                    {% elif current_content.type == 'note' %}
                                        <span class="meta-badge">
                                            <i class="fas fa-file-pdf"></i>
                                            Ù…Ø§Ø¯Ø© Ù…ÙƒØªÙˆØ¨Ø©
                                        </span>
                                    {% elif current_content.type == 'quiz' %}
                                        <span class="meta-badge">
                                            <i class="far fa-clock"></i>
                                            {{ current_content.content.time_limit|default:'15' }} Ø¯Ù‚ÙŠÙ‚Ø©
                                        </span>
                                        <span class="meta-badge">
                                            <i class="fas fa-question-circle"></i>
                                            Ø§Ø®ØªØ¨Ø§Ø±
                                        </span>
                                    {% endif %}
                                </div>
                            {% endif %}
                        </div>
                    {% endif %}
                {% elif request.GET.content_type and request.GET.content_id %}
                    <!-- Content Not Found -->
                    <div class="content-not-found">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ØºÙŠØ± Ù…ØªÙˆÙØ± Ø£Ùˆ ØªÙ… Ø­Ø°ÙÙ‡.
                            <a href="{% url 'courseviewpage' course.id %}" class="alert-link">Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù„Ø¯ÙˆØ±Ø©</a>
                        </div>
                    </div>
                {% elif modules.exists and not current_content %}
                    <!-- No Content Available -->
                    <div class="no-content-message">
                        <div class="text-center p-5">
                            <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
                            <h4>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰ Ù…ØªØ§Ø­ Ø­Ø§Ù„ÙŠØ§Ù‹</h4>
                            <p class="text-muted">Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ù…Ø­ØªÙˆÙ‰ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ±Ø³ Ø¨Ø¹Ø¯.</p>
                        </div>
                    </div>
                {% else %}
                    <!-- Course Overview with Enhanced Progress -->
                    <div class="course-overview">
                        <div class="content-header">
                            <h1 class="content-title">
                                <i class="fas fa-graduation-cap text-primary me-2"></i>
                                Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¯ÙˆØ±Ø© {{ course.name }}
                            </h1>
                            <p class="course-description">{{ course.description }}</p>
                        </div>
                        
                        <!-- Enhanced Progress Information -->
                        <div class="enhanced-progress-info">
                            <h5><i class="fas fa-chart-line me-2"></i>Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ù…Ø­Ø³Ù†</h5>
                            
                            <!-- Ø¥Ø±Ø´Ø§Ø¯Ø§Øª Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… -->
                            <div class="usage-guide mb-3 p-3 bg-white rounded border-start border-primary border-4">
                                <h6 class="text-primary mb-2">
                                    <i class="fas fa-info-circle me-2"></i>
                                    ÙƒÙŠÙÙŠØ© Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
                                </h6>
                                <div class="row">
                                    <div class="col-md-4">
                                        <small class="text-muted d-block mb-1">
                                            <i class="fas fa-video text-primary me-1"></i>
                                            <strong>Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª:</strong> ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¥ÙƒÙ…Ø§Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©
                                        </small>
                                    </div>
                                    <div class="col-md-4">
                                        <small class="text-muted d-block mb-1">
                                            <i class="fas fa-file-pdf text-danger me-1"></i>
                                            <strong>Ù…Ù„ÙØ§Øª PDF:</strong> Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± "ØªØ­Ø¯ÙŠØ¯ ÙƒÙ…Ù‚Ø±ÙˆØ¡" Ø¨Ø¹Ø¯ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©
                                        </small>
                                    </div>
                                    <div class="col-md-4">
                                        <small class="text-muted d-block mb-1">
                                            <i class="fas fa-sticky-note text-warning me-1"></i>
                                            <strong>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± "ØªØ­Ø¯ÙŠØ¯ ÙƒÙ…Ù‚Ø±ÙˆØ¡" Ø¨Ø¹Ø¯ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©
                                        </small>
                                    </div>
                                </div>
                            </div>
                            
                            <p class="mb-2">ÙŠØªÙ… Ø­Ø³Ø§Ø¨ ØªÙ‚Ø¯Ù…Ùƒ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø®Ù…Ø³Ø© Ù„ÙƒÙ„ Ù…ÙˆØ¯ÙŠÙˆÙ„:</p>
                            <div class="progress-breakdown">
                                <div class="progress-item">
                                    <i class="fas fa-video"></i>
                                    <span>ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…ÙˆØ¯ÙŠÙˆÙ„</span>
                                </div>
                                <div class="progress-item">
                                    <i class="fas fa-file-pdf"></i>
                                    <span>Ù…Ù„Ù PDF</span>
                                </div>
                                <div class="progress-item">
                                    <i class="fas fa-sticky-note"></i>
                                    <span>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</span>
                                </div>
                                <div class="progress-item">
                                    <i class="fas fa-tasks"></i>
                                    <span>Ø§Ù„ÙˆØ§Ø¬Ø¨</span>
                                </div>
                                <div class="progress-item">
                                    <i class="fas fa-question-circle"></i>
                                    <span>Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</span>
                                </div>
                            </div>
                            <div class="mt-2">
                                <small><i class="fas fa-info-circle me-1"></i>
                                ÙƒÙ„ Ù…ÙˆØ¯ÙŠÙˆÙ„ ÙŠØ³Ø§ÙˆÙŠ <span id="module-percentage">{{ modules|length|default:1 }}</span>% Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙˆØ±Ø©ØŒ ÙˆÙƒÙ„ Ø¹Ù†ØµØ± ÙŠØ³Ø§ÙˆÙŠ <span id="element-percentage">{{ modules|length|default:1 }}</span>%</small>
                            </div>
                        </div>
                        
                        <!-- Course Stats -->
                        <div class="course-stats">
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-icon bg-primary">
                                        <i class="fas fa-video"></i>
                                    </div>
                                    <div class="stat-info">
                                        <span class="stat-number">{{ total_videos|default:0 }}</span>
                                        <span class="stat-label">ÙÙŠØ¯ÙŠÙˆ</span>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon bg-success">
                                        <i class="fas fa-file-alt"></i>
                                    </div>
                                    <div class="stat-info">
                                        <span class="stat-number">{{ total_notes|default:0 }}</span>
                                        <span class="stat-label">Ù…Ù„Ø§Ø­Ø¸Ø©</span>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon bg-warning">
                                        <i class="fas fa-question-circle"></i>
                                    </div>
                                    <div class="stat-info">
                                        <span class="stat-number">{{ total_quizzes|default:0 }}</span>
                                        <span class="stat-label">Ø§Ø®ØªØ¨Ø§Ø±</span>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon bg-info">
                                        <i class="fas fa-tasks"></i>
                                    </div>
                                    <div class="stat-info">
                                        <span class="stat-number">{{ assignments_count|default:0 }}</span>
                                        <span class="stat-label">ÙˆØ§Ø¬Ø¨</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Welcome Message -->
                        <div class="welcome-message">
                            {% if not modules.exists and not course.course_videos.exists and not course.course_notes.exists and not course.course_assignments.exists and not course.course_quizzes.exists %}
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰ Ù…ØªØ§Ø­ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆØ±Ø© Ø¨Ø¹Ø¯. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø¯Ø±Ø¨.
                                </div>
                            {% else %}
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ù…Ø´Ø§Ù‡Ø¯ØªÙ‡ Ø£Ùˆ Ù…ØªØ§Ø¨Ø¹Ø© Ø¯Ø±Ø§Ø³ØªÙ‡
                                </div>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
            </div>
            
            <!-- Discussion Section -->
            {% if current_content %}
            <div class="discussion-section">
                
                {% include 'website/courses/components/_discussion.html' %}
            </div>
            {% endif %}
            
            <!-- Navigation Controls -->
            <div class="navigation-controls">
                {% if prev_content %}
                <a href="{% url 'courseviewpage' course.id %}?content_type={{ prev_content.type }}&content_id={{ prev_content.content.id }}" 
                   class="nav-btn nav-prev">
                    <i class="fas fa-arrow-right"></i>
                    Ø§Ù„Ø³Ø§Ø¨Ù‚
                </a>
                {% endif %}
                
                <!-- Course Completion -->
                {% if progress_percentage >= 80 %}
                <div class="completion-section">
                    {% if progress_percentage >= 100 or enrollment.status == 'completed' %}
                        <button class="nav-btn nav-completed" disabled>
                            <i class="fas fa-check-circle"></i>
                            Ù…ÙƒØªÙ…Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­
                        </button>
                    {% elif progress_percentage >= 90 %}
                        <button class="nav-btn nav-complete" data-course-id="{{ course.id }}">
                            <i class="fas fa-trophy"></i>
                            Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ±Ø©
                        </button>
                    {% endif %}
                    
                    <!-- Final Exam Button -->
                    {% if progress_percentage >= 85 and course.course_quizzes.exists %}
                        {% for final_quiz in course.course_quizzes.all %}
                            {% if final_quiz.quiz_type == 'final' or 'Ù†Ù‡Ø§Ø¦ÙŠ' in final_quiz.title %}
                            <a href="{% url 'courseviewpage' course.id %}?content_type=quiz&content_id={{ final_quiz.id }}" 
                               class="nav-btn nav-exam">
                                <i class="fas fa-graduation-cap"></i>
                                Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
                            </a>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                </div>
                {% endif %}
                
                {% if next_content %}
                <a href="{% url 'courseviewpage' course.id %}?content_type={{ next_content.type }}&content_id={{ next_content.content.id }}" 
                   class="nav-btn nav-next">
                    Ø§Ù„ØªØ§Ù„ÙŠ
                    <i class="fas fa-arrow-left"></i>
                </a>
                {% endif %}
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="course-sidebar" dir="rtl">
            {% include 'website/courses/components/course_content_sidebar.html' %}
            
            <!-- Instructor Card -->
            <div class="instructor-card">
                <h5 class="instructor-title"><i class="fas fa-user-tie me-2"></i>Ù…Ù‚Ø¯Ù… Ø§Ù„Ø¯ÙˆØ±Ø©</h5>
                <div class="instructor-info">
                    {% if course.teacher.profile.image %}
                    <img src="{{ course.teacher.profile.image.url }}" 
                         class="instructor-avatar" 
                         alt="{{ course.teacher.profile.name }}">
                    {% else %}
                    <div class="avatar-placeholder">
                        {{ course.teacher.profile.name|slice:':1'|upper }}
                    </div>
                    {% endif %}
                    <div class="instructor-details">
                        <h6>{{ course.teacher.profile.name }}</h6>
                        <p>Ù…Ø¯Ø±Ø¨ Ù…Ø¹ØªÙ…Ø¯</p>
                    </div>
                </div>
            </div>
            
            <button class="btn btn-sm btn-outline-light ms-2 recalculate-progress-btn" 
                     data-course-id="{{ course.id }}" 
                     onclick="recalculateProgress({{ course.id }})"
                     title="Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙ‚Ø¯Ù…">
                 <i class="fas fa-sync-alt"></i>
             </button>
             
             {% if enrollment and is_enrolled %}
             <button class="btn btn-sm btn-success ms-2" 
                     onclick="testProgressSystem()"
                     title="Ø§Ø®ØªØ¨Ø§Ø± Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚Ø¯Ù…">
                 <i class="fas fa-play"></i>
             </button>
             
             <button class="btn btn-sm btn-warning ms-2" 
                     onclick="testFinalExamCheck()"
                     title="Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ">
                 <i class="fas fa-graduation-cap"></i>
             </button>
             {% endif %}
        </div>
    </div>
</div>

<script>
// Ø¯ÙˆØ§Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù„Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
async function testProgressSystem() {
    console.log('ğŸ§ª Testing Enhanced Progress System...');
    
    if (window.enhancedProgressSystem) {
        // Ø§Ø®ØªØ¨Ø§Ø± Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙ‚Ø¯Ù…
        const progress = await window.enhancedProgressSystem.calculateOverallProgress();
        const report = window.enhancedProgressSystem.getProgressReport();
        
        console.log('ğŸ“Š Progress System Test Results:');
        console.log('- Current Progress:', progress.toFixed(1) + '%');
        console.log('- Detailed Report:', report);
        
        alert(`ğŸ¯ Ù†ØªØ§Ø¦Ø¬ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù…:\nØ§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ: ${progress.toFixed(1)}%\nØ§Ù„Ù…ÙˆØ¯ÙŠÙˆÙ„Ø§Øª: ${report.totalModules}\nØ§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©: ${report.completedElements}/${report.totalElements}`);
    } else {
        console.warn('âš ï¸ Enhanced Progress System not ready yet');
        alert('âš ï¸ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø³Ù† ØºÙŠØ± Ø¬Ø§Ù‡Ø² Ø¨Ø¹Ø¯. Ø§Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ ÙˆØ­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
    }
}

async function testFinalExamCheck() {
    console.log('ğŸ“ Testing Final Exam Check...');
    
    if (window.enhancedProgressSystem) {
        try {
            const result = await window.enhancedProgressSystem.checkFinalExamFromDatabase();
            
            if (result) {
                console.log('âœ… Final exam passed - Course should be completed');
                alert('ğŸ‰ ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! Ù„Ù‚Ø¯ Ø§Ø¬ØªØ²Øª Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø¨Ù†Ø¬Ø§Ø­!\nØ³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚Ø¯Ù… Ø¥Ù„Ù‰ 100%');
            } else {
                console.log('âŒ Final exam not passed or not found');
                alert('ğŸ“ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù…ØªØ­Ø§Ù† Ù†Ù‡Ø§Ø¦ÙŠ Ù…ÙƒØªÙ…Ù„ Ø¨Ù†Ø¬Ø§Ø­.\nØ£ÙƒÙ…Ù„ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ±Ø©.');
            }
        } catch (error) {
            console.error('âŒ Error testing final exam check:', error);
            alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ÙØ­Øµ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: ' + error.message);
        }
    } else {
        console.warn('âš ï¸ Enhanced Progress System not ready yet');
        alert('âš ï¸ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø³Ù† ØºÙŠØ± Ø¬Ø§Ù‡Ø² Ø¨Ø¹Ø¯. Ø§Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ ÙˆØ­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
    }
}

// Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙ‚Ø¯Ù…
async function recalculateProgress(courseId) {
    console.log('ğŸ”„ Recalculating progress for course:', courseId);
    
    try {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        const response = await fetch(`/api/course/${courseId}/recalculate-progress/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            console.log('âœ… Progress recalculated:', data.progress + '%');
            alert(`âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙ‚Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­!\nØ§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯: ${data.progress.toFixed(1)}%`);
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            console.error('âŒ Server error:', data.message);
            alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙ‚Ø¯Ù…: ' + data.message);
        }
    } catch (error) {
        console.error('âŒ Network error:', error);
        alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ' + error.message);
    }
}
</script>

{% endblock %}
