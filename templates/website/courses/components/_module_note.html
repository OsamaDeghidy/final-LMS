<!-- Module Note Component -->
<div class="note-display-container" data-module-id="{{ current_content.content.module.id }}">
    {% if current_content.content.note_file %}
    <div class="note-viewer-container">
        <div class="note-header">
            <h4><i class="fas fa-sticky-note text-warning me-2"></i>{{ current_content.content.title }}</h4>
            <div class="note-actions">
                <a href="{{ current_content.content.note_file.url }}" target="_blank" class="btn btn-primary btn-sm">
                    <i class="fas fa-eye me-2"></i>عرض في صفحة جديدة
                </a>
                <a href="{{ current_content.content.note_file.url }}" download class="btn btn-success btn-sm">
                    <i class="fas fa-download me-2"></i>تحميل الملف
                </a>
                <button type="button" class="btn btn-info btn-sm mark-note-read-btn" 
                        data-note-id="{{ current_content.content.id }}" 
                        data-course-id="{{ course.id }}">
                    <i class="fas fa-check-circle me-2"></i>تحديد كمقروء
                </button>
            </div>
        </div>
        
        <!-- Note Content -->
        <div class="note-content mt-4">
            {% if current_content.content.content %}
                <div class="note-text">
                    {{ current_content.content.content|safe }}
                </div>
            {% else %}
                <div class="note-preview">
                    {% if current_content.content.note_file.name|lower|slice:'-4:' == '.pdf' %}
                        <iframe src="{{ current_content.content.note_file.url }}" width="100%" height="600px" style="border: none;"></iframe>
                    {% elif current_content.content.note_file.name|lower|slice:'-5:' == '.docx' or current_content.content.note_file.name|lower|slice:'-4:' == '.doc' %}
                        <div class="alert alert-info">
                            <i class="fas fa-file-word me-2"></i>
                            هذا الملف من نوع Word. يرجى تحميله لعرض المحتوى.
                        </div>
                    {% else %}
                        <div class="alert alert-secondary">
                            <i class="fas fa-file-alt me-2"></i>
                            معاينة غير متاحة لهذا النوع من الملفات. يرجى تحميل الملف لعرضه.
                        </div>
                    {% endif %}
                </div>
            {% endif %}
        </div>
        
        <!-- Note Metadata -->
        <div class="note-meta mt-4">
            <div class="row">
                <div class="col-md-6">
                    <div class="meta-item">
                        <i class="far fa-calendar-alt me-2"></i>
                        <span>تاريخ الإضافة: {{ current_content.content.created_at|date:"Y/m/d" }}</span>
                    </div>
                </div>
                <div class="col-md-6 text-md-end">
                    <div class="meta-item">
                        <i class="fas fa-file me-2"></i>
                        <span>حجم الملف: {{ current_content.content.note_file.size|filesizeformat }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <!-- No Note Available -->
    <div class="note-placeholder text-center p-5 bg-light rounded">
        <i class="fas fa-sticky-note fa-3x text-muted mb-3"></i>
        <h4>لا توجد ملاحظات متاحة</h4>
        <p class="text-muted">لم يتم إضافة ملاحظات لهذه الوحدة بعد</p>
    </div>
    {% endif %}
</div>

{% block extra_js %}
<script>
// Mark note as read when the button is clicked
document.addEventListener('DOMContentLoaded', function() {
    const markNoteReadBtn = document.querySelector('.mark-note-read-btn');
    
    if (markNoteReadBtn) {
        markNoteReadBtn.addEventListener('click', function() {
            const noteId = this.dataset.noteId;
            const courseId = this.dataset.courseId;
            
            // Mark note as read
            fetch(`/courses/mark-content-viewed/note/${noteId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Update UI to show note is read
                    const noteItem = document.querySelector(`[data-note-id="${noteId}"]`);
                    if (noteItem) {
                        noteItem.closest('.content-item').classList.add('completed');
                    }
                    
                    // Show success message
                    showMessage('تم تحديد الملاحظة كمقروءة بنجاح', 'success');
                    
                    // Update progress bars
                    updateProgressBars(data.progress);
                }
            });
        });
    }
});
</script>
{% endblock %}
