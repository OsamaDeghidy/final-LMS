{% extends 'main/dashboard_base.html' %}
{% load static %}

{% block title %}تحديث الدورة{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/course-creation.css' %}">
<script src="{% static 'js/course-image-upload.js' %}"></script>
<script src="{% static 'js/course-creation.js' %}"></script>
<script src="{% static 'js/course-update.js' %}"></script>
<style>
  .bg-danger-light {
    background-color: rgba(220, 53, 69, 0.1);
  }
</style>
{% endblock %}

{% block dashboard_content %}
    <div class="col-lg-8">
      <div class="card shadow-lg border-0 mb-5">
        <div class="card-header text-white" style="background: linear-gradient(135deg, #1d3b53 0%, #2a5a7c 100%);">
          <h2 class="mb-0 text-center">
            <i class="fas fa-edit me-2"></i> تحديث الدورة
          </h2>
        </div>
        <div class="card-body p-4">
          <form id="course-form" method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
            {% csrf_token %}
            
            <!-- Step Progress Bar -->
            <div id="stepper" class="d-flex justify-content-between mb-5">
              <div class="step-line"></div>
              <div class="step-item active">
                <div class="step-circle">1</div>
                <div class="text-center mt-2">معلومات الدورة</div>
              </div>
              <div class="step-item">
                <div class="step-circle">2</div>
                <div class="text-center mt-2">الموديولات</div>
              </div>
              <div class="step-item">
                <div class="step-circle">3</div>
                <div class="text-center mt-2">المراجعة</div>
              </div>
            </div>
            
            <!-- Step 1: Course Info -->
            <div class="step-card">
              <h4 class="mb-4 text-primary">معلومات الدورة الأساسية</h4>
              
              <div class="mb-3">
                <label class="form-label fw-bold">عنوان الدورة</label>
                <div class="input-group">
                  <span class="input-group-text bg-light"><i class="fas fa-book text-primary"></i></span>
                  <input type="text" class="form-control" name="name" required placeholder="أدخل عنوان الدورة" value="{{ course.name }}">
                </div>
              </div>
              
              <div class="mb-3">
                <label class="form-label fw-bold">وصف مختصر</label>
                <div class="input-group">
                  <span class="input-group-text bg-light"><i class="fas fa-align-left text-primary"></i></span>
                  <input type="text" class="form-control" name="small_description" placeholder="ملخص يظهر في بطاقة الدورة" value="{{ course.small_description }}">
                </div>
              </div>
              
              <div class="row mb-3">
                <div class="col-md-6">
                  <label class="form-label fw-bold">السعر ($)</label>
                  <div class="input-group">
                    <span class="input-group-text bg-light">$</span>
                    <input type="number" class="form-control" name="price" step="0.01" min="0" placeholder="0.00" required value="{{ course.price }}">
                  </div>
                </div>
                <div class="col-md-6">
                  <label class="form-label fw-bold">مستوى الدورة</label>
                  <select class="form-select" name="level" required>
                    <option value="">-- اختر المستوى --</option>
                    <option value="beginner" {% if course.level == "beginner" %}selected{% endif %}>مبتدئ</option>
                    <option value="intermediate" {% if course.level == "intermediate" %}selected{% endif %}>متوسط</option>
                    <option value="advanced" {% if course.level == "advanced" %}selected{% endif %}>متقدم</option>
                  </select>
                </div>
              </div>
              
              <div class="mb-3">
                <label class="form-label fw-bold">صورة الدورة</label>
                {% if course.image_course %}
                  <div class="mb-2">
                    <img src="{{ course.image_course.url }}" class="img-thumbnail" style="max-width: 200px;">
                  </div>
                {% endif %}
                <div class="card border-dashed p-3 text-center" style="cursor: pointer;" onclick="document.getElementById('image_course').click()">
                  <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-2"></i>
                  <h5 class="text-muted">انقر لتغيير الصورة</h5>
                  <p class="small text-muted">الحجم الموصى به: 800x450 بكسل</p>
                  <input type="file" class="d-none" id="image_course" name="image_course" accept="image/*">
                </div>
              </div>
              
              <div class="mb-3">
                <label class="form-label fw-bold">الوصف التفصيلي</label>
                <textarea class="form-control" name="description" rows="5" required placeholder="اشرح محتوى الدورة بشكل تفصيلي...">{{ course.description }}</textarea>
              </div>
              
              <div class="mb-3">
                <label class="form-label fw-bold">ما الذي سيتعلمه الطالب؟</label>
                <textarea class="form-control" name="learned" rows="5" placeholder="أدخل كل نقطة في سطر منفصل...">{{ course.learned }}</textarea>
                <div class="form-text">ضع كل نقطة تعلم في سطر جديد</div>
              </div>

              <!-- PDF Files Section -->
              <div class="card mb-4 border-primary">
                <div class="card-header bg-light">
                  <h5 class="mb-0"><i class="fas fa-file-pdf text-danger me-2"></i>ملفات PDF للدورة</h5>
                </div>
                <div class="card-body">
                  <div class="row">
                    <!-- Syllabus PDF -->
                    <div class="col-md-6 mb-3">
                      <label class="form-label fw-bold">منهج الدورة التفصيلي (PDF)</label>
                      {% if course.syllabus_pdf %}
                      <div class="mb-2">
                        <div class="d-flex align-items-center p-2 bg-light rounded">
                          <i class="fas fa-file-pdf text-danger me-2 fa-lg"></i>
                          <div class="flex-grow-1 text-truncate">{{ course.syllabus_pdf.name }}</div>
                          <div class="form-check ms-2">
                            <input class="form-check-input delete-checkbox" type="checkbox" name="delete_syllabus_pdf" id="delete_syllabus_pdf" value="1">
                            <label class="form-check-label text-danger" for="delete_syllabus_pdf">حذف</label>
                          </div>
                        </div>
                      </div>
                      {% endif %}
                      <input type="file" class="form-control" name="syllabus_pdf" accept="application/pdf">
                      <small class="text-muted">اختياري. حجم الملف الأقصى: 10 ميجابايت</small>
                    </div>
                    
                    <!-- Materials PDF -->
                    <div class="col-md-6 mb-3">
                      <label class="form-label fw-bold">مواد إضافية للدورة (PDF)</label>
                      {% if course.materials_pdf %}
                      <div class="mb-2">
                        <div class="d-flex align-items-center p-2 bg-light rounded">
                          <i class="fas fa-file-pdf text-danger me-2 fa-lg"></i>
                          <div class="flex-grow-1 text-truncate">{{ course.materials_pdf.name }}</div>
                          <div class="form-check ms-2">
                            <input class="form-check-input delete-checkbox" type="checkbox" name="delete_materials_pdf" id="delete_materials_pdf" value="1">
                            <label class="form-check-label text-danger" for="delete_materials_pdf">حذف</label>
                          </div>
                        </div>
                      </div>
                      {% endif %}
                      <input type="file" class="form-control" name="materials_pdf" accept="application/pdf">
                      <small class="text-muted">اختياري. حجم الملف الأقصى: 10 ميجابايت</small>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="row mb-3">
                <div class="col-md-6">
                  <label class="form-label fw-bold">فئة الدورة</label>
                  <select class="form-select" name="category">
                    <option value="">-- اختر الفئة --</option>
                    {% for cat in categories %}
                      <option value="{{ cat.id }}" {% if course.category.id == cat.id %}selected{% endif %}>{{ cat.name }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label fw-bold">المؤسسة</label>
                  <select class="form-select" name="organization">
                    <option value="">-- اختر المؤسسة --</option>
                    {% for org in organizations %}
                      <option value="{{ org.id }}" {% if course.organization.id == org.id %}selected{% endif %}>{{ org.name }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
              
              <div class="mb-3">
                <label class="form-label fw-bold">وسوم الدورة</label>
                <div class="input-group">
                  <span class="input-group-text bg-light"><i class="fas fa-tags text-primary"></i></span>
                  <input type="text" class="form-control" name="tags" placeholder="برمجة، تطوير، تصميم (افصل بينهم بفاصلة)" value="{{ tags_string }}">
                </div>
              </div>
              
              <div class="d-flex justify-content-end mt-4">
                <button type="button" class="btn btn-primary px-4" onclick="nextStep()">
                  التالي <i class="fas fa-arrow-left ms-2"></i>
                </button>
              </div>
            </div>
            
            <!-- Step 2: Modules -->
            <div class="step-card d-none">
              <h4 class="mb-4 text-primary">موديولات الدورة</h4>
              
              <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                أضف أو عدل موديولات الدورة. يمكنك إضافة فيديوهات وملاحظات واختبارات لكل موديول.
              </div>
              
              <div id="modules-container">
                <!-- Existing Modules -->
                {% for module in course.module_set.all %}
                <div class="card mb-4 module-card" id="existing_module_{{ module.id }}">
                  <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-layer-group text-primary me-2"></i>الموديول {{ module.number }}</h5>
                    <button type="button" class="btn btn-sm btn-outline-danger remove-module-btn" data-module-id="{{ module.id }}">
                      <i class="fas fa-trash"></i>
                    </button>
                    <input type="hidden" name="delete_module_{{ module.id }}" id="delete_module_{{ module.id }}" value="0">
                  </div>
                  <div class="card-body">
                    <!-- Module Info -->
                    <div class="mb-3">
                      <label class="form-label fw-bold">اسم الموديول</label>
                      <input type="text" class="form-control" name="module_name_existing_{{ module.id }}" placeholder="أدخل اسم الموديول" value="{{ module.name }}" required>
                      <input type="hidden" name="module_id_existing_{{ module.id }}" value="{{ module.id }}">
                    </div>
                    
                    <!-- Videos -->
                    <div class="mb-3">
                      <label class="form-label fw-bold">الفيديوهات الحالية</label>
                      <div class="list-group mb-3">
                        {% for video in module.video_set.all %}
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                          <div>
                            <i class="fas fa-video text-primary me-2"></i>
                            {{ video.name }}
                          </div>
                          <div class="form-check">
                            <input class="form-check-input delete-checkbox" type="checkbox" name="delete_video_{{ video.id }}" id="delete_video_{{ video.id }}" value="1">
                            <label class="form-check-label text-danger" for="delete_video_{{ video.id }}">
                              حذف
                            </label>
                          </div>
                        </div>
                        {% empty %}
                        <div class="list-group-item text-muted">لا توجد فيديوهات</div>
                        {% endfor %}
                      </div>
                      
                      <label class="form-label fw-bold">إضافة فيديوهات جديدة</label>
                      <input type="file" class="form-control" name="module_videos_existing_{{ module.id }}" accept="video/*" multiple>
                      <small class="text-muted">الصيغ المدعومة: MP4, MOV, AVI</small>
                    </div>
                    
                    <!-- Notes -->
                    <div class="mb-3">
                      <label class="form-label fw-bold">ملاحظات إضافية</label>
                      <div class="list-group mb-3">
                        {% for note in module.notes_set.all %}
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                          <div>
                            <i class="fas fa-sticky-note text-primary me-2"></i>
                            {{ note.description|truncatechars:50 }}
                          </div>
                          <div class="form-check">
                            <input class="form-check-input delete-checkbox" type="checkbox" name="delete_note_{{ note.id }}" id="delete_note_{{ note.id }}" value="1">
                            <label class="form-check-label text-danger" for="delete_note_{{ note.id }}">
                              حذف
                            </label>
                          </div>
                        </div>
                        {% empty %}
                        <div class="list-group-item text-muted">لا توجد ملاحظات</div>
                        {% endfor %}
                      </div>
                      
                      <div class="d-flex justify-content-between align-items-center mb-2">
                        <div></div>
                        <button type="button" class="btn btn-sm btn-outline-primary add-note-btn" data-module-id="existing_{{ module.id }}">
                          <i class="fas fa-plus me-1"></i>إضافة ملاحظة
                        </button>
                      </div>
                      <div class="notes-container" id="notes_container_existing_{{ module.id }}">
                        <div class="input-group mb-2">
                          <textarea class="form-control" name="module_notes_existing_{{ module.id }}_0" rows="2" placeholder="أدخل ملاحظة"></textarea>
                          <button type="button" class="btn btn-outline-danger remove-note-btn" data-note-id="{{ note.id }}">
                            <i class="fas fa-times"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Video Names -->
                    <div class="mb-3">
                      <label class="form-label fw-bold">عناوين الفيديوهات الجديدة</label>
                      <div class="d-flex justify-content-between align-items-center mb-2">
                        <div></div>
                        <button type="button" class="btn btn-sm btn-outline-primary add-video-name-btn" data-module-id="existing_{{ module.id }}">
                          <i class="fas fa-plus me-1"></i>إضافة عنوان
                        </button>
                      </div>
                      <div class="video-names-container" id="video_names_container_existing_{{ module.id }}">
                        <div class="input-group mb-2">
                          <span class="input-group-text bg-light"><i class="fas fa-video text-primary"></i></span>
                          <input type="text" class="form-control" name="video_name_existing_{{ module.id }}_0" placeholder="أدخل عنوان الفيديو">
                    <button type="button" class="btn btn-sm btn-outline-danger remove-module-btn" data-module-id="{{ module.id }}">
                      <i class="fas fa-trash"></i>
                    </button>
                    <input type="hidden" name="delete_module_{{ module.id }}" id="delete_module_{{ module.id }}" value="0">
                        </div>
                      </div>
                    </div>
                    
                    <!-- Quiz Section -->
                    <div class="card mb-3 border-primary">
                      <div class="card-header bg-light">
                        <div class="form-check form-switch">
                          {% with module_quiz=module.module_quizzes.first %}
                          <input class="form-check-input quiz-toggle" type="checkbox" id="has_quiz_existing_{{ module.id }}" name="has_quiz_existing_{{ module.id }}" {% if module_quiz %}checked{% endif %}>
                          <label class="form-check-label fw-bold" for="has_quiz_existing_{{ module.id }}">إضافة اختبار للموديول</label>
                          {% endwith %}
                        </div>
                      </div>
                      <div class="quiz-section card-body" id="quiz_section_existing_{{ module.id }}" style="display: {% if module.module_quizzes.first %}block{% else %}none{% endif %};">
                        {% with module_quiz=module.module_quizzes.first %}
                        {% if module_quiz %}
                        <input type="hidden" name="quiz_id_existing_{{ module.id }}" value="{{ module_quiz.id }}">
                        {% endif %}
                        <div class="mb-3">
                          <label class="form-label fw-bold">عنوان الاختبار</label>
                          <input type="text" class="form-control" name="quiz_title_existing_{{ module.id }}" placeholder="أدخل عنوان الاختبار" value="{% if module_quiz %}{{ module_quiz.title }}{% endif %}">
                        </div>
                        <div class="mb-3">
                          <label class="form-label fw-bold">وصف الاختبار</label>
                          <textarea class="form-control" name="quiz_description_existing_{{ module.id }}" rows="2" placeholder="وصف مختصر للاختبار">{% if module_quiz %}{{ module_quiz.description }}{% endif %}</textarea>
                        </div>
                        <div class="row mb-3">
                          <div class="col-md-6">
                            <label class="form-label fw-bold">درجة النجاح (%)</label>
                            <input type="number" class="form-control" name="quiz_pass_mark_existing_{{ module.id }}" min="0" max="100" value="{% if module_quiz %}{{ module_quiz.pass_mark }}{% else %}50{% endif %}">
                          </div>
                          <div class="col-md-6">
                            <label class="form-label fw-bold">مدة الاختبار (دقائق)</label>
                            <input type="number" class="form-control" name="quiz_time_limit_existing_{{ module.id }}" min="1" value="{% if module_quiz %}{{ module_quiz.time_limit }}{% else %}10{% endif %}">
                          </div>
                        </div>
                        
                        <div class="questions-container" id="questions_container_existing_{{ module.id }}">
                          <!-- Existing Questions -->
                          {% if module_quiz %}
                          {% for question in module_quiz.questions.all %}
                          <div class="card mb-3 question-card" id="existing_question_{{ question.id }}">
                            <div class="card-body">
                              <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0">سؤال #{{ forloop.counter }}</h6>
                                <button type="button" class="btn btn-sm btn-outline-danger remove-question-btn" data-question-id="{{ question.id }}">
                                  <i class="fas fa-times"></i>
                                </button>
                                <input type="hidden" name="delete_question_{{ question.id }}" id="delete_question_{{ question.id }}" value="0" class="delete-question-input">
                              </div>
                              
                              <div class="mb-3">
                                <input type="text" class="form-control" name="question_text_existing_{{ module.id }}_{{ question.id }}" placeholder="نص السؤال" required value="{{ question.text }}">
                                <input type="hidden" name="question_id_existing_{{ module.id }}_{{ forloop.counter }}" value="{{ question.id }}">
                              </div>
                              
                              <div class="mb-3">
                                <select class="form-select question-type-select" name="question_type_existing_{{ module.id }}_{{ question.id }}">
                                  <option value="multiple_choice" {% if question.question_type == 'multiple_choice' %}selected{% endif %}>اختيار من متعدد</option>
                                  <option value="true_false" {% if question.question_type == 'true_false' %}selected{% endif %}>صح أو خطأ</option>
                                  <option value="short_answer" {% if question.question_type == 'short_answer' %}selected{% endif %}>إجابة قصيرة</option>
                                </select>
                              </div>
                              
                              <div class="answers-container" id="answers_existing_question_{{ question.id }}">
                                <!-- Existing Answers -->
                                {% if question.question_type == 'multiple_choice' %}
                                  {% for answer in question.answers.all %}
                                  <div class="answer-item mb-2">
                                    <div class="input-group">
                                      <div class="input-group-text">
                                        <input class="form-check-input mt-0" type="radio" name="correct_answer_existing_{{ question.id }}" value="{{ forloop.counter0 }}" {% if answer.is_correct %}checked{% endif %}>
                                      </div>
                                      <input type="text" class="form-control" name="answer_text_existing_{{ question.id }}_{{ forloop.counter0 }}" placeholder="الإجابة {{ forloop.counter }}" required value="{{ answer.text }}">
                                <button type="button" class="btn btn-sm btn-outline-danger remove-answer-btn" data-answer-id="{{ answer.id }}">
                                  <i class="fas fa-times"></i>
                                </button>
                                <input type="hidden" name="delete_answer_{{ answer.id }}" id="delete_answer_{{ answer.id }}" value="0" class="delete-answer-input">
                                    </div>
                                  </div>
                                  {% endfor %}
                                {% elif question.question_type == 'true_false' %}
                                  <div class="answer-item mb-2">
                                    <div class="input-group">
                                      <div class="input-group-text">
                                        <input class="form-check-input mt-0" type="radio" name="correct_answer_existing_{{ question.id }}" value="0" {% if question.answers.first.is_correct %}checked{% endif %}>
                                      </div>
                                      <input type="text" class="form-control" name="answer_text_existing_{{ question.id }}_0" value="صح" readonly>
                                    </div>
                                  </div>
                                  <div class="answer-item mb-2">
                                    <div class="input-group">
                                      <div class="input-group-text">
                                        <input class="form-check-input mt-0" type="radio" name="correct_answer_existing_{{ question.id }}" value="1" {% if question.answers.last.is_correct %}checked{% endif %}>
                                      </div>
                                      <input type="text" class="form-control" name="answer_text_existing_{{ question.id }}_1" value="خطأ" readonly>
                                    </div>
                                  </div>
                                {% elif question.question_type == 'short_answer' %}
                                  <div class="mb-3">
                                    <label class="form-label">الإجابة الصحيحة</label>
                                    <input type="text" class="form-control" name="answer_short_existing_{{ question.id }}" placeholder="أدخل الإجابة الصحيحة" required value="{{ question.answers.first.text }}">
                                  </div>
                                {% endif %}
                              </div>
                              
                              <button type="button" class="btn btn-sm btn-outline-primary mt-2 add-answer-btn" {% if question.question_type != 'multiple_choice' %}style="display: none;"{% endif %}>
                                <i class="fas fa-plus me-1"></i>إضافة إجابة
                              </button>
                            </div>
                          </div>
                          {% endfor %}
                          {% endif %}
                        </div>
                        
                        <button type="button" class="btn btn-primary w-100 mt-3 add-question-btn" data-module-id="existing_{{ module.id }}">
                          <i class="fas fa-plus me-1"></i>إضافة سؤال جديد
                        </button>
                        {% endwith %}
                      </div>
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>
              
              <div class="d-flex justify-content-center my-4">
                <button type="button" class="btn btn-success" id="add-module-btn">
                  <i class="fas fa-plus me-2"></i> إضافة موديول جديد
                </button>
              </div>
              
              <div class="d-flex justify-content-between mt-4">
                <button type="button" class="btn btn-outline-secondary px-4" onclick="prevStep()">
                  <i class="fas fa-arrow-right me-2"></i> السابق
                </button>
                <button type="button" class="btn btn-primary px-4" onclick="nextStep()">
                  التالي <i class="fas fa-arrow-left ms-2"></i>
                </button>
              </div>
            </div>
            
            <!-- Step 3: Review -->
            <div class="step-card d-none">
              <h4 class="mb-4 text-primary">مراجعة الدورة</h4>
              
              <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                راجع معلومات الدورة قبل الحفظ. تأكد من إضافة جميع المعلومات المطلوبة.
              </div>
              
              <div class="d-flex justify-content-between mt-4">
                <button type="button" class="btn btn-outline-secondary px-4" onclick="prevStep()">
                  <i class="fas fa-arrow-right me-2"></i> السابق
                </button>
                <button type="button" class="btn btn-success px-4" id="submit-course-btn">
                  <i class="fas fa-save me-2"></i> حفظ التغييرات
                </button>
              </div>
            </div>
            
          </form>
        </div>
      </div>
    </div>
{% endblock dashboard_content %}
