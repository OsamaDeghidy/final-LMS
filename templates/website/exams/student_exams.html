{% extends 'main/dashboard_base.html' %}
{% load static %}

{% block title %}الاختبارات - {{ course.name }}{% endblock %}

{% block head %}
{{ block.super }}
<style>
    .exam-card {
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .exam-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    .progress-circle {
        position: relative;
        height: 120px;
        width: 120px;
        background-color: #f8f9fa;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto;
    }
    .progress-circle:after {
        content: '';
        width: 100%;
        height: 100%;
        border-radius: 50%;
        border: 6px solid #eee;
        position: absolute;
        top: 0;
        left: 0;
    }
    .progress-circle > span {
        font-size: 1.5rem;
        font-weight: bold;
    }
    .progress-circle .progress-fill {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        border: 6px solid transparent;
        border-top-color: #28a745;
        border-right-color: #28a745;
        transform: rotate(45deg);
    }
    .status-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1;
    }
    .timer-warning {
        color: #dc3545;
        animation: blink 1s infinite;
    }
    @keyframes blink {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
</style>
{% endblock %}

{% block dashboard_content %}
<div class="container py-5 col-lg-8">
    <div class="row mb-4">
        <div class="col-md-10">
            <h1 class="h2 mb-0">الاختبارات المتاحة</h1>
            <p class="text-muted">{{ course.name }}</p>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            {% if exams %}
                {% for exam in exams %}
                    <div class="card shadow-sm border-0 mb-4">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <h3 class="h5 mb-0">{{ exam.title }}</h3>
                            {% if exam.is_final %}
                                <span class="badge bg-warning text-dark">اختبار نهائي</span>
                            {% endif %}
                        </div>
                        <div class="card-body">
                            {% if exam.description %}
                                <div class="mb-3">{{ exam.description|safe }}</div>
                            {% endif %}
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <ul class="list-unstyled mb-0">
                                        <li class="mb-2">
                                            <i class="fas fa-question-circle me-2 text-primary"></i>
                                            <span>{{ exam.questions.count }} سؤال</span>
                                        </li>
                                        <li class="mb-2">
                                            <i class="fas fa-clock me-2 text-primary"></i>
                                            <span>{% if exam.time_limit %}{{ exam.time_limit }} دقيقة{% else %}غير محدد{% endif %}</span>
                                        </li>
                                        <li>
                                            <i class="fas fa-award me-2 text-primary"></i>
                                            <span>درجة النجاح: {{ exam.pass_mark }}%</span>
                                        </li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <ul class="list-unstyled mb-0">
                                        {% if exam.start_date or exam.end_date %}
                                            <li class="mb-2">
                                                <i class="fas fa-calendar-alt me-2 text-primary"></i>
                                                <span>
                                                    {% if exam.start_date %}
                                                        متاح من: {{ exam.start_date|date:"Y-m-d H:i" }}
                                                    {% endif %}
                                                    {% if exam.end_date %}
                                                        <br>حتى: {{ exam.end_date|date:"Y-m-d H:i" }}
                                                    {% endif %}
                                                </span>
                                            </li>
                                        {% endif %}
                                        <li class="mb-2">
                                            <i class="fas fa-redo-alt me-2 text-primary"></i>
                                            <span>
                                                {% if exam.allow_multiple_attempts %}
                                                    يسمح بـ {{ exam.max_attempts }} محاولة
                                                {% else %}
                                                    محاولة واحدة فقط
                                                {% endif %}
                                            </span>
                                        </li>
                                        <li>
                                            <i class="fas fa-check-circle me-2 text-primary"></i>
                                            <span>
                                                {% if exam.show_answers_after %}
                                                    تظهر الإجابات الصحيحة بعد الانتهاء
                                                {% else %}
                                                    لا تظهر الإجابات الصحيحة
                                                {% endif %}
                                            </span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            
                            <div class="mt-4">
                                {% if user_attempts %}
                                    <div class="mb-3">
                                        <h5 class="h6">محاولاتك السابقة:</h5>
                                        <div class="table-responsive">
                                            <table class="table table-sm table-bordered">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>رقم المحاولة</th>
                                                        <th>التاريخ</th>
                                                        <th>النتيجة</th>
                                                        <th>الحالة</th>
                                                        <th></th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for attempt in user_attempts %}
                                                        {% if attempt.exam.id == exam.id %}
                                                            <tr>
                                                                <td>{{ attempt.attempt_number }}</td>
                                                                <td>{{ attempt.start_time|date:"Y-m-d H:i" }}</td>
                                                                <td>
                                                                    {% if attempt.score != None %}
                                                                        {{ attempt.score|floatformat:1 }}%
                                                                    {% else %}
                                                                        -
                                                                    {% endif %}
                                                                </td>
                                                                <td>
                                                                    {% if attempt.passed %}
                                                                        <span class="badge bg-success">ناجح</span>
                                                                    {% elif attempt.passed == False %}
                                                                        <span class="badge bg-danger">غير ناجح</span>
                                                                    {% else %}
                                                                        <span class="badge bg-warning text-dark">غير مكتمل</span>
                                                                    {% endif %}
                                                                </td>
                                                                <td>
                                                                    {% if attempt.end_time %}
                                                                        <a href="{% url 'exam_results' attempt_id=attempt.id %}" class="btn btn-sm btn-outline-primary">
                                                                            عرض النتائج
                                                                        </a>
                                                                    {% else %}
                                                                        <a href="{% url 'take_exam' exam_id=exam.id %}" class="btn btn-sm btn-outline-warning">
                                                                            استكمال المحاولة
                                                                        </a>
                                                                    {% endif %}
                                                                </td>
                                                            </tr>
                                                        {% endif %}
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                {% endif %}
                                
                                {% if can_take_exam %}
                                    <a href="{% url 'take_exam' exam_id=exam.id %}" class="btn btn-primary">
                                        <i class="fas fa-play-circle me-2"></i>بدء الاختبار
                                    </a>
                                {% else %}
                                    <button class="btn btn-secondary" disabled>
                                        {% if not exam.is_active %}
                                            الاختبار غير متاح حالياً
                                        {% elif exam.start_date and now < exam.start_date %}
                                            الاختبار غير متاح حتى {{ exam.start_date|date:"Y-m-d H:i" }}
                                        {% elif exam.end_date and now > exam.end_date %}
                                            انتهت فترة الاختبار
                                        {% elif not exam.allow_multiple_attempts and user_attempts_count >= 1 %}
                                            تم استنفاذ المحاولات المتاحة
                                        {% elif exam.allow_multiple_attempts and user_attempts_count >= exam.max_attempts %}
                                            تم استنفاذ الحد الأقصى للمحاولات ({{ exam.max_attempts }})
                                        {% else %}
                                            غير متاح
                                        {% endif %}
                                    </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="card shadow-sm border-0">
                    <div class="card-body text-center py-5">
                        <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                        <p class="mb-0">لا توجد اختبارات متاحة حالياً لهذه الدورة.</p>
                    </div>
                </div>
            {% endif %}
        </div>
        
        <div class="col-lg-4">
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-light">
                    <h3 class="h5 mb-0">معلومات الدورة</h3>
                </div>
                <div class="card-body">
                    <h4 class="h6">{{ course.name }}</h4>
                    <p class="text-muted small">{{ course.description|truncatewords:30 }}</p>
                    
                    <hr>
                    
                    <div class="d-flex justify-content-between mb-2">
                        <span>تقدمك في الدورة:</span>
                        <span class="fw-bold">{{ progress|floatformat:0 }}%</span>
                    </div>
                    <div class="progress mb-4">
                        <div class="progress-bar bg-success" role="progressbar" aria-valuenow="{{ progress|default:0 }}" aria-valuemin="0" aria-valuemax="100" style="width: {{ progress|default:0 }}%"></div>
                    </div>
                    
                    <a href="{% url 'courseviewpage' course_id=course.id %}" class="btn btn-outline-primary btn-sm w-100">
                        <i class="fas fa-arrow-left me-2"></i>العودة إلى الدورة
                    </a>
                </div>
            </div>
            
            {% if upcoming_exams %}
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-light">
                        <h3 class="h5 mb-0">اختبارات قادمة</h3>
                    </div>
                    <div class="card-body p-0">
                        <ul class="list-group list-group-flush">
                            {% for exam in upcoming_exams %}
                                <li class="list-group-item">
                                    <h5 class="h6 mb-1">{{ exam.title }}</h5>
                                    <p class="small text-muted mb-1">
                                        <i class="fas fa-calendar-alt me-1"></i> 
                                        متاح من: {{ exam.start_date|date:"Y-m-d H:i" }}
                                    </p>
                                    {% if exam.module %}
                                        <span class="badge bg-light text-dark">{{ exam.module.title }}</span>
                                    {% endif %}
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock dashboard_content %}
